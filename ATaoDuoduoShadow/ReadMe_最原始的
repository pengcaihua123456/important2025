
## 1.ä¸ºå•¥æˆ‘çš„ç”µå•†é¡¹ç›®ç”¨æ’ä»¶åŒ–?

è€ç”¨æˆ·æ— æ³•ä½“éªŒæœ€æ–°çš„åŠŸèƒ½ï¼Œå¿…é¡»å‘ç‰ˆæœ¬ï¼Œå¼ºåˆ¶å‡çº§æ‰è¡Œï¼ ä½†æœ‰çš„ç”¨æˆ·ä¸å–œæ¬¢å¼ºåˆ¶å‡çº§ï¼

å¸¸è§„å‘ç‰ˆéœ€è¦7-15å¤©å®¡æ ¸å‘¨æœŸï¼Œé”™è¿‡è¥é”€æ—¶æœº

 **åŒ…ä½“ç§¯è†¨èƒ€**ï¼šæ¯æ¬¡æ–°å¢åŠŸèƒ½éƒ½å¢åŠ APKä½“ç§¯ï¼Œå½±å“ä¸‹è½½è½¬åŒ–ç‡
```
**çµæ´»æ€§å·®**ï¼šæ— æ³•é’ˆå¯¹ä¸åŒç”¨æˆ·ç¾¤ä½“å±•ç¤ºä¸åŒè´­ç‰©æµç¨‹
```

## 2.æ•´ä½“çš„æ¶æ„æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿåˆ†å±‚
å“ªéƒ¨åˆ†æ˜¯å®¿ä¸»ï¼Œå“ªéƒ¨åˆ†æ˜¯æ’ä»¶ï¼Ÿ

## 3.shadowçš„å°è£…æ€æƒ³

## 3.å¤§å‹ç”µå•†å¹³å°åŒ11ä¸­çš„æ•´ä¸ªæµç¨‹å›¾ï¼šåŒ…å«7ä¸ªéœ€æ±‚ç‚¹


## 7. æ’ä»¶å¥”æºƒï¼Œæ€ä¹ˆå¤„ç† (é‡ç‚¹)
è‡ªåŠ¨å›é€€åˆ°åŸºç¡€ç‰ˆæœ¬ï¼Ÿæ˜¯æ‰€æœ‰çš„ç”¨æˆ·éƒ½å›é€€å—?
é™çº§ç­–ç•¥
æ¡†æ¶å±‚å¼‚å¸¸æ•è·
æ’ä»¶å´©æºƒä¸ä¼šå¯¼è‡´ä¸»è¿›ç¨‹å´©æºƒ,å¯ä»¥å•ç‹¬é‡å¯æ’ä»¶è¿›ç¨‹,å†…å­˜éš”ç¦»ï¼Œé¿å…OOMå½±å“ä¸»è¿›ç¨‹
å¼‚å¸¸æ‹¦æˆªå±‚ï¼ˆæ ¸å¿ƒé˜²æŠ¤ï¼‰+æ¶æ„å±‚é¢çš„éš”ç¦»
æ™ºèƒ½é™çº§ç­–ç•¥
çƒ­ä¿®å¤


## 8.å®é™…æ•ˆæœå¯¹æ¯”
| æŒ‡æ ‡                | ä¼ ç»Ÿæ–¹å¼       | Shadowæ’ä»¶åŒ–     | æå‡æ•ˆæœ   |
|---------------------|---------------|------------------|-----------|
| åŠŸèƒ½ä¸Šçº¿æ—¶é—´        | 7-15å¤©        | 2å°æ—¶            | -90%      |
| ç”¨æˆ·å—å½±å“èŒƒå›´      | 100%ç”¨æˆ·      | 10%ç°åº¦é€æ­¥æ”¾å¼€  | é£é™©é™ä½  |
| å´©æºƒç‡              | 0.5%          | 0.08%            | -84%      |
| è´­ç‰©è½¦è½¬åŒ–ç‡        | 15.2%         | 18.7%            | +23%      |
| è®¢å•å–æ¶ˆç‡          | 8.3%          | 5.1%             | -39%      |
| çƒ­ä¿®å¤ç”Ÿæ•ˆæ—¶é—´      | 4å°æ—¶         | 5åˆ†é’Ÿ            | -98%      |


## 7.æ€§èƒ½é—®é¢˜
----æ’ä»¶æ€§èƒ½ç›‘æ§
-   æ€§èƒ½ç›‘æ§ï¼ˆåŠ è½½æ—¶é—´ã€å†…å­˜å ç”¨ï¼‰
-   å´©æºƒç‡ç»Ÿè®¡


## 9. shadowå¦‚ä½•æ›´æ–°ï¼šå¤šæ’ä»¶ç®¡ç†ã€ç‰ˆæœ¬æ§åˆ¶ä¸çƒ­æ›´æ–°ç­–ç•¥ !Â  å®¿ä¸»çš„ç‰ˆæœ¬å’Œæ’ä»¶å¦‚æœè¦æ›´æ–°æ€ä¹ˆæ ·
æ’ä»¶åŠ¨æ€æ›´æ–°ç­–ç•¥, å¤šæ’ä»¶ç®¡ç†ï¼šåŒæ—¶åŠ è½½å¤šä¸ªæ’ä»¶çš„ç­–ç•¥ï¼Ÿ æ’ä»¶é¢„åŠ è½½ç­–ç•¥

ä¸¾ä¾‹ï¼š ç¬¬ä¸€æ¬¡ç‰ˆæœ¬ï¼Œå®¿ä¸»A,åŒ…å«2ä¸ªæ’ä»¶ï¼Œæ’ä»¶B å’Œæ’ä»¶Cï¼Œ éƒ½æ˜¯1.0ç‰ˆæœ¬
  è¿‡äº†7å¤©ï¼Œå‘ç°æ’ä»¶Bæœ‰bugï¼Œçƒ­ä¿®å¤ï¼Œæ’ä»¶Bæ˜¯2.0ç‰ˆæœ¬
  ç¬¬äºŒæ¬¡å‘ç‰ˆï¼šå®¿ä¸»A 3.0ï¼Œæ’ä»¶Bï¼ŒCéƒ½æœ‰æ›´æ–°ï¼ŒåŒæ—¶æ–°å¢æ’ä»¶D   éƒ½æ˜¯3.0ç‰ˆæœ¬
  æ€è€ƒï¼šå®¿ä¸»Açš„1.0ç‰ˆæœ¬,éœ€è¦åŠ è½½æ’ä»¶B 2.0ç‰ˆæœ¬,C 1.0ç‰ˆæœ¬
        å®¿ä¸»Açš„3.0ç‰ˆæœ¬,éœ€è¦åŠ è½½æ’ä»¶B 3.0ç‰ˆæœ¬,C 3.0ç‰ˆæœ¬ ï¼Œ D 3.0 ç‰ˆæœ¬

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¿ä¸»A 1.0       â”‚     â”‚  æ’ä»¶çƒ­æ›´æ–°       â”‚     â”‚  å®¿ä¸»A 3.0       â”‚
â”‚  - æ’ä»¶B 1.0     â”‚â”€â”€â”€â”€â–¶â”‚  æ’ä»¶B 2.0       â”‚â”€â”€â”€â”€â–¶â”‚  - æ’ä»¶B 3.0     â”‚
â”‚  - æ’ä»¶C 1.0     â”‚     â”‚  æ’ä»¶C 1.0       â”‚     â”‚  - æ’ä»¶C 3.0     â”‚
â”‚                 â”‚     â”‚                 â”‚     â”‚  - æ’ä»¶D 3.0     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
æ’ä»¶ç‰ˆæœ¬ç®¡ç†é…ç½®ï¼ˆJSONæ ¼å¼ï¼‰
Q1: å‘ç‰ˆè¶Šç´¯è¶Šå¤šï¼Œé‚£ä¹ˆæ—§çš„æ’ä»¶è¶Šæ¥è¶Šå¤šï¼Œæ€ä¹ˆåŠ? æœ‰çš„æ—¶å€™åˆéœ€è¦ç‰ˆæœ¬å›é€€ï¼Ÿ
æ™ºèƒ½æ¸…ç†ç®—æ³•ï¼Œæ¯ä¸ªæ’ä»¶æœ€å¤šä¿ç•™5ä¸ªç‰ˆæœ¬

```
åœ¨å¤§å‹ç”µå•†å¹³å°åŒ11ä¸­çš„åº”ç”¨ï¼šç”¨shadowï¼Œå®ç°ä»¥ä¸‹10ç‚¹éœ€æ±‚, å¯ä»¥æ”¹å˜é¡ºåºï¼Œè®©å…¶æ›´åŠ å¤åˆé€»è¾‘
ä¸ºå•¥æˆ‘çš„ç”µå•†é¡¹ç›®ç”¨æ’ä»¶åŒ–?
æ•´ä½“çš„æ¶æ„æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿåˆ†å±‚?
shadowçš„å°è£…ç”µå•†é¡¹ç›®æ€æƒ³æ˜¯æ€ä¹ˆæ ·?

1.å¦‚ä½•åŠ è½½ä¸€ä¸ªåŒ11æ´»åŠ¨æ’ä»¶
2.æ’ä»¶å¥”æºƒï¼Œæ€ä¹ˆå¤„ç† (é‡ç‚¹)
  åŒ11æ´»åŠ¨æ’ä»¶æœ‰å¥”æºƒé—®é¢˜
è‡ªåŠ¨å›é€€åˆ°åŸºç¡€ç‰ˆæœ¬ï¼Ÿæ˜¯æ‰€æœ‰çš„ç”¨æˆ·éƒ½å›é€€å—?
 é™çº§ç­–ç•¥
3.å¦‚ä½•å¸è½½æ’ä»¶?
 åŒ11æ´»åŠ¨ç»“æŸ,æ’ä»¶åœ¨æœ¬åœ°æš‚ç”¨ç£ç›˜
4. å¦‚ä½•åŠ è½½æ’ä»¶ä¸­æ–°å¢ä¸€ä¸ªActivityï¼ŒåŒ11æ´»åŠ¨æ’ä»¶
å››å¤§ç»„ä»¶æ”¯æŒæƒ…å†µï¼šActivity å®Œå…¨æ”¯æŒï¼ŒService/Broadcast/ContentProvider çš„é™åˆ¶ä¸æ›¿ä»£æ–¹æ¡ˆ
5. å¦‚ä½•åŠ è½½æ–°å¢çš„Fragmentï¼ŒåŒ11æ´»åŠ¨æ’ä»¶?
6.å®¿ä¸»ä¸æ’ä»¶ä¹‹é—´å¦‚ä½•é«˜æ•ˆé€šä¿¡ï¼Ÿ
æ’ä»¶è·å–å®¿ä¸»ä¿¡æ¯ï¼š(ç”¨æˆ·ä¿¡æ¯ï¼šæ’ä»¶éœ€è¦è·å–ç™»å½•çŠ¶æ€ã€æ”¶è´§åœ°å€)
å®¿ä¸»è·å–æ’ä»¶ä¿¡æ¯ï¼šï¼ˆè´­ç‰©è½¦åŒæ­¥ï¼šæ’ä»¶æ·»åŠ å•†å“ï¼Œå®¿ä¸»è´­ç‰©è½¦å®æ—¶æ›´æ–°ï¼‰
æ’ä»¶ä¸å®¿ä¸»é€šä¿¡ï¼šåŒä¸€ä¸ªè¿›ç¨‹ï¼Œ é€šè¿‡é¢„å®šä¹‰æ¥å£ï¼ˆServiceã€Callbackï¼‰å®ç°åŒå‘è°ƒç”¨
æ’ä»¶å’Œæ’ä»¶é€šä¿¡ï¼š
7.shadowå¦‚ä½•æ›´æ–°ï¼šå¤šæ’ä»¶ç®¡ç†ã€ç‰ˆæœ¬æ§åˆ¶ä¸çƒ­æ›´æ–°ç­–ç•¥ !Â  å®¿ä¸»çš„ç‰ˆæœ¬å’Œæ’ä»¶å¦‚æœè¦æ›´æ–°æ€ä¹ˆæ ·
æ’ä»¶åŠ¨æ€æ›´æ–°ç­–ç•¥, å¤šæ’ä»¶ç®¡ç†ï¼šåŒæ—¶åŠ è½½å¤šä¸ªæ’ä»¶çš„ç­–ç•¥
æ’ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç† &&  æ’ä»¶åŠ¨æ€åŒ–éƒ¨ç½²
       ç¬¬ä¸€æ¬¡ç‰ˆæœ¬ï¼Œå®¿ä¸»A,åŒ…å«2ä¸ªæ’ä»¶ï¼Œæ’ä»¶B å’Œæ’ä»¶Cï¼Œ éƒ½æ˜¯1.0ç‰ˆæœ¬
       è¿‡äº†7å¤©ï¼Œå‘ç°æ’ä»¶Bæœ‰bugï¼Œçƒ­ä¿®å¤ï¼Œæ’ä»¶Bæ˜¯2.0ç‰ˆæœ¬
       ç¬¬äºŒæ¬¡å‘ç‰ˆï¼šå®¿ä¸»A 3.0ï¼Œæ’ä»¶Bï¼ŒCéƒ½æœ‰æ›´æ–°ï¼ŒåŒæ—¶æ–°å¢æ’ä»¶D   éƒ½æ˜¯3.0ç‰ˆæœ¬
8.çƒ­ä¿®å¤ä¸€ä¸ªç±»:ä¼˜æƒ åˆ¸å åŠ è®¡ç®—é€»è¾‘ç´§æ€¥ä¿®å¤ï¼ŒåŒæ—¶æœ‰ä¸€ä¸ªå¥”æºƒé—®é—®é¢˜
9.çƒ­ä¿®å¤æ›¿æ¢ä¸€ä¸ªèµ„æºæ–‡ä»¶: å‘ç°æ´»åŠ¨ä¸»å›¾ä¾µçŠ¯ç‰ˆæƒï¼Œéœ€ç«‹å³æ›´æ¢
æ’ä»¶å†…ä½¿ç”¨è‡ªå·±çš„èµ„æºï¼Œé¿å…å†²çª
10.çƒ­ä¿®å¤ä¸€ä¸ªsoæ–‡ä»¶:å›¾ç‰‡åŠ è½½soåº“ï¼Œä¼šæœ‰å¥”æºƒ
```

***

#  1. ç”µå•†å¤§ä¿ƒæ’ä»¶åŒ–å®æˆ˜ï¼šç”¨ Shadow å®ç°â€œè´­ç‰©æµç¨‹â€åŠ¨æ€æ›´æ–°
åœ¨å¤§å‹ç”µå•†å¹³å°åŒ11ä¸­çš„åº”ç”¨ï¼šç”¨shadowï¼Œå®ç°ä»¥ä¸‹10ç‚¹éœ€æ±‚,
```
1.å¦‚ä½•åŠ è½½ä¸€ä¸ªæ–°å¢çš„æ’ä»¶
2.æ’ä»¶å¥”æºƒï¼Œæ€ä¹ˆå¤„ç†
3.å¦‚ä½•å¸è½½æ’ä»¶?
4. å¦‚ä½•åŠ è½½æ’ä»¶ä¸­æ–°å¢ä¸€ä¸ªActivityï¼Œ
å››å¤§ç»„ä»¶æ”¯æŒæƒ…å†µï¼šActivity å®Œå…¨æ”¯æŒï¼ŒService/Broadcast/ContentProvider çš„é™åˆ¶ä¸æ›¿ä»£æ–¹æ¡ˆ
5. å¦‚ä½•åŠ è½½æ–°å¢çš„Fragment
6.å®¿ä¸»ä¸æ’ä»¶ä¹‹é—´å¦‚ä½•é«˜æ•ˆé€šä¿¡ï¼Ÿ
æ’ä»¶è·å–å®¿ä¸»ä¿¡æ¯ï¼š
å®¿ä¸»è·å–æ’ä»¶ä¿¡æ¯ï¼š
æ’ä»¶å’Œæ’ä»¶é€šä¿¡ï¼š
7.shadowå¦‚ä½•æ›´æ–°ï¼šå¤šæ’ä»¶ç®¡ç†ã€ç‰ˆæœ¬æ§åˆ¶ä¸çƒ­æ›´æ–°ç­–ç•¥ !Â  å®¿ä¸»çš„ç‰ˆæœ¬å’Œæ’ä»¶å¦‚æœè¦æ›´æ–°æ€ä¹ˆæ ·
æ’ä»¶åŠ¨æ€æ›´æ–°ç­–ç•¥, å¤šæ’ä»¶ç®¡ç†ï¼šåŒæ—¶åŠ è½½å¤šä¸ªæ’ä»¶çš„ç­–ç•¥
8.çƒ­ä¿®å¤ä¸€ä¸ªç±»
9.çƒ­ä¿®å¤æ›¿æ¢ä¸€ä¸ªèµ„æºæ–‡ä»¶
10.çƒ­ä¿®å¤ä¸€ä¸ªsoæ–‡ä»¶
```


# ç”µå•†å¤§ä¿ƒæ’ä»¶åŒ–å®æˆ˜ï¼šåŸºäº Shadow å®ç°åŒ11è´­ç‰©æµç¨‹åŠ¨æ€æ›´æ–°

## ğŸ“‹ ç²¾åæç‚¼ï¼šä¸ƒå¤§æ ¸å¿ƒåŠŸèƒ½æŠ€æœ¯è¦ç‚¹

1.å¦‚ä½•åŠ è½½ä¸€ä¸ªåŒ11æ’ä»¶ï¼Ÿ

æœ¬æ¥æœ‰4ä¸ªtabé¡µé¢ï¼ŒæœåŠ¡å™¨åŠ¨æ€ä¸‹å‘ï¼Œæ–°å¢äº†ä¸€ä¸ªtabï¼ åŒ11ä¸»ä¼šåœº

ç‚¹å‡»tabï¼Œå®¿ä¸»åŠ è½½åŒ11æ´»åŠ¨ä¸»æ’ä»¶ï¼
```
å¸¸è§„æ¶æ„ï¼š
é¦–é¡µ â†’ åˆ†ç±» â†’ è´­ç‰©è½¦ â†’ æˆ‘çš„

åŒ11æ¶æ„ï¼š
é¦–é¡µ â†’ åŒ11ä¸»ä¼šåœº â†’ åˆ†ä¼šåœº â†’ è´­ç‰©è½¦ â†’ æˆ‘çš„
           â†‘
        æ’ä»¶åŒ–å®ç°
```

```
â”€ plugins/                        # æ’ä»¶é›†åˆ
â”‚   â”œâ”€â”€ promotion-double11/         # åŒ11æ´»åŠ¨ä¸»æ’ä»¶
â”‚   â”œâ”€â”€ shopping-cart-double11/     # åŒ11è´­ç‰©è½¦æ’ä»¶
â”‚   â”œâ”€â”€ flash-sale/                 # é™æ—¶ç§’æ€æ’ä»¶
â”‚   â”œâ”€â”€ coupon-manager/             # ä¼˜æƒ åˆ¸ç®¡ç†æ’ä»¶
â”‚   â””â”€â”€ payment-double11/           # åŒ11æ”¯ä»˜æ’ä»¶
```
å¦‚ä½•å¸è½½ä¸€ä¸ªåŒ11æ’ä»¶?

æœåŠ¡å™¨å…³é—­å…¥å£ï¼Œé‚£ä¹ˆåŒ11æ’ä»¶ä¸€ç›´å­˜åœ¨ï¼Œéœ€è¦å¸è½½å®ƒï¼Œæ€ä¹ˆå¸è½½ï¼Œä¸å†™ä»£ç ï¼Œè®²ä¸‹é€»è¾‘
æ’ä»¶æ”¾åœ¨å“ªä¸ªç›®å½•ï¼Ÿä¼šä¸ä¼šè¢«æ¸…ç†æ‰?

## **å…³é”®æ­¥éª¤ï¼šå¦‚ä½•åˆ é™¤æ’ä»¶APKæ–‡ä»¶**

### **APKæ–‡ä»¶çš„å­˜æ”¾ä½ç½®**

```
/data/data/com.taobao/  # Appç§æœ‰ç›®å½•
â”œâ”€â”€ files/
â”‚   â”œâ”€â”€ plugins/        # æ’ä»¶å­˜æ”¾ç›®å½•
â”‚   â”‚   â”œâ”€â”€ promotion-double11_v2.3.1.apk   # æ’ä»¶APKæ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ promotion-double11_v2.3.1.sig   # ç­¾åæ–‡ä»¶
â”‚   â”‚   â””â”€â”€ promotion-double11/             # æ’ä»¶è§£å‹ç›®å½•
â”‚   â””â”€â”€ hotfix/         # çƒ­ä¿®å¤æ–‡ä»¶
```


### **1. åŠ¨æ€åŠ è½½APKï¼Œæ–°å¢Activity**Â -Â **åŒ11é™æ—¶ç§’æ€æ´»åŠ¨**

**æ ¸å¿ƒä»·å€¼**ï¼šåˆ†é’Ÿçº§ä¸Šçº¿æ–°åŠŸèƒ½ï¼Œè§„é¿åº”ç”¨å•†åº—å®¡æ ¸é£é™©
**æŠ€æœ¯è¦ç‚¹**ï¼š

-   **ShadowActivityä»£ç†æœºåˆ¶**ï¼šé€šè¿‡ä»£ç†Activityæ¡¥æ¥å®¿ä¸»ä¸æ’ä»¶
-   **ç‹¬ç«‹ClassLoader**ï¼šæ¯ä¸ªæ’ä»¶æ‹¥æœ‰ç‹¬ç«‹çš„ç±»åŠ è½½å™¨ï¼Œéš”ç¦»å†²çª
-   **èµ„æºéš”ç¦»æ–¹æ¡ˆ**ï¼šæ’ä»¶ä½¿ç”¨ç‹¬ç«‹çš„Resourceså¯¹è±¡ï¼Œé¿å…èµ„æºIDå†²çª
-   **åŠ¨æ€æ³¨å†Œç»„ä»¶**ï¼šé€šè¿‡è§£ææ’ä»¶ManifeståŠ¨æ€æ³¨å†ŒActivity

**å®ç°éš¾ç‚¹**ï¼š

-   Activityç”Ÿå‘½å‘¨æœŸåŒæ­¥
-   ä¸Šä¸‹æ–‡ï¼ˆContextï¼‰çš„æ­£ç¡®ä¼ é€’
-   èµ„æºæ–‡ä»¶çš„å¤šè¯­è¨€é€‚é…

### **2. çƒ­ä¿®å¤ä¸€ä¸ªç±»**Â -Â **ä¼˜æƒ åˆ¸å åŠ è®¡ç®—é€»è¾‘ç´§æ€¥ä¿®å¤**

**æ ¸å¿ƒä»·å€¼**ï¼šå®æ—¶ä¿®å¤çº¿ä¸ŠBugï¼Œæ— éœ€ç”¨æˆ·é‡å¯App
**æŠ€æœ¯è¦ç‚¹**ï¼š

-   **DexClassLoaderçƒ­åŠ è½½**ï¼šé€šè¿‡æ–°çš„ClassLoaderåŠ è½½ä¿®å¤ç±»
-   **ç±»åŠ è½½å™¨è·¯å¾„æ›¿æ¢**ï¼šä¿®æ”¹ClassLoaderçš„dexElementsæ•°ç»„
-   **ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥**ï¼šç¡®ä¿çƒ­ä¿®å¤åŒ…ä¸å®¿ä¸»ç‰ˆæœ¬å…¼å®¹
-   **ç°åº¦å‘å¸ƒæ§åˆ¶**ï¼šé€æ­¥æ¨é€ä¿®å¤ï¼Œç›‘æ§å´©æºƒç‡

**å®ç°éš¾ç‚¹**ï¼š

-   é¿å…ç±»åŠ è½½å†²çª
-   ç¡®ä¿ä¿®å¤ç±»çš„å­—æ®µã€æ–¹æ³•ç­¾åä¸€è‡´
-   å¤„ç†å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„ç±»åŠ è½½

### **3. çƒ­ä¿®å¤æ›¿æ¢èµ„æºæ–‡ä»¶**Â -Â **æ´»åŠ¨å›¾ç‰‡/æ–‡æ¡ˆç´§æ€¥æ›´æ¢**

**æ ¸å¿ƒä»·å€¼**ï¼šå¿«é€Ÿå“åº”å†…å®¹å˜æ›´ï¼Œæ”¯æŒA/Bæµ‹è¯•
**æŠ€æœ¯è¦ç‚¹**ï¼š

-   **AssetManageråŠ¨æ€æ·»åŠ è·¯å¾„**ï¼šåå°„è°ƒç”¨addAssetPathæ–¹æ³•
-   **èµ„æºIDæ˜ å°„æœºåˆ¶**ï¼šå»ºç«‹æ’ä»¶èµ„æºIDä¸å®¿ä¸»èµ„æºIDçš„æ˜ å°„å…³ç³»
-   **å›¾ç‰‡ç¼“å­˜ç®¡ç†**ï¼šæ¸…ç†Glide/Frescoç­‰å›¾ç‰‡æ¡†æ¶çš„ç¼“å­˜
-   **èµ„æºç‰ˆæœ¬æ§åˆ¶**ï¼šæ”¯æŒå¤šå¥—èµ„æºå¹¶è¡Œï¼Œå¿«é€Ÿåˆ‡æ¢

**å®ç°éš¾ç‚¹**ï¼š

-   èµ„æºIDå†²çªè§£å†³
-   å¤šè¯­è¨€èµ„æºåŒæ­¥æ›´æ–°
-   å›¾ç‰‡é¢„åŠ è½½å’Œå†…å­˜ç®¡ç†

### **4. çƒ­ä¿®å¤ä¸€ä¸ªSOåº“**Â -Â **å›¾ç‰‡åŠ è½½åº“æ€§èƒ½ä¼˜åŒ–**

**æ ¸å¿ƒä»·å€¼**ï¼šç´§æ€¥ä¿®å¤Nativeå±‚é—®é¢˜ï¼Œæå‡æ€§èƒ½
**æŠ€æœ¯è¦ç‚¹**ï¼š

-   **å¤šæ¶æ„é€‚é…**ï¼šarmeabi-v7aã€arm64-v8aã€x86ç­‰æ¶æ„æ”¯æŒ
-   **åŠ¨æ€åº“è·¯å¾„ç®¡ç†**ï¼šä¿®æ”¹nativeLibraryDirectoriesåŠ è½½é¡ºåº
-   **æƒé™è®¾ç½®**ï¼šè®¾ç½®SOæ–‡ä»¶å¯æ‰§è¡Œæƒé™
-   **å›æ»šæœºåˆ¶**ï¼šä¿®å¤å¤±è´¥æ—¶è‡ªåŠ¨å›é€€åˆ°åŸç‰ˆæœ¬

**å®ç°éš¾ç‚¹**ï¼š

-   ä¸åŒCPUæ¶æ„çš„å…¼å®¹æ€§
-   SOåº“ç¬¦å·è¡¨ç‰ˆæœ¬åŒ¹é…
-   å†…å­˜æ³„æ¼æ£€æµ‹å’Œé¢„é˜²

### **5. å¤šæ’ä»¶ç®¡ç†ä¸çƒ­æ›´æ–°**Â -Â **å…¨é“¾è·¯è´­ç‰©æµç¨‹æ’ä»¶åŒ–**

**æ ¸å¿ƒä»·å€¼**ï¼šå®ç°ç”µå•†å…¨é“¾è·¯åŠ¨æ€åŒ–ï¼Œæ”¯æŒç°åº¦å‘å¸ƒ
**æŠ€æœ¯è¦ç‚¹**ï¼š

-   **æ’ä»¶ä¾èµ–ç®¡ç†**ï¼šå»ºç«‹æ’ä»¶é—´çš„ä¾èµ–å…³ç³»å›¾
-   **ç‰ˆæœ¬å…¼å®¹æ€§çŸ©é˜µ**ï¼šç®¡ç†æ’ä»¶ä¸å®¿ä¸»çš„ç‰ˆæœ¬å…¼å®¹å…³ç³»
-   **å¢é‡æ›´æ–°æœºåˆ¶**ï¼šä»…ä¸‹è½½å˜åŒ–çš„èµ„æºï¼ŒèŠ‚çœæµé‡
-   **ç°åº¦å‘å¸ƒç­–ç•¥**ï¼šæŒ‰ç”¨æˆ·IDã€åœ°åŒºã€è®¾å¤‡ç­‰ç»´åº¦ç°åº¦

**å®ç°éš¾ç‚¹**ï¼š

-   æ’ä»¶é—´é€šä¿¡å’Œæ•°æ®å…±äº«
-   å¹¶å‘åŠ è½½çš„çº¿ç¨‹å®‰å…¨
-   èµ„æºå†²çªå’Œç‰ˆæœ¬å›æ»š

### **6. å®¿ä¸»ä¸æ’ä»¶é€šä¿¡**Â -Â **åŒå‘é«˜æ•ˆæ•°æ®äº¤æ¢**

**æ ¸å¿ƒä»·å€¼**ï¼šå®ç°æ’ä»¶ä¸å®¿ä¸»æ·±åº¦é›†æˆï¼Œå…±äº«æ•°æ®å’ŒæœåŠ¡
**æŠ€æœ¯è¦ç‚¹**ï¼š

-   **Binderé€šä¿¡æœºåˆ¶**ï¼šé€šè¿‡AIDLå®ç°è·¨è¿›ç¨‹é€šä¿¡
-   **æ¥å£æ ‡å‡†åŒ–**ï¼šå®šä¹‰ç»Ÿä¸€çš„é€šä¿¡æ¥å£è§„èŒƒ
-   **äº‹ä»¶æ€»çº¿**ï¼šå®ç°ç»„ä»¶é—´çš„äº‹ä»¶å‘å¸ƒ/è®¢é˜…
-   **Fragmentå®¹å™¨**ï¼šæ”¯æŒæ’ä»¶FragmentåµŒå…¥å®¿ä¸»é¡µé¢

**å®ç°éš¾ç‚¹**ï¼š

-   æ•°æ®åºåˆ—åŒ–å’Œååºåˆ—åŒ–
-   å¼‚æ­¥å›è°ƒçš„å¤„ç†
-   å†…å­˜æ³„æ¼é¢„é˜²

### **7. æ´»åŠ¨ç»“æŸå¸è½½æ’ä»¶**Â -Â **èµ„æºæ™ºèƒ½æ¸…ç†**

**æ ¸å¿ƒä»·å€¼**ï¼šè‡ªåŠ¨æ¸…ç†è¿‡æœŸæ’ä»¶ï¼Œé‡Šæ”¾å­˜å‚¨ç©ºé—´
**æŠ€æœ¯è¦ç‚¹**ï¼š

-   **æ™ºèƒ½å¸è½½æ—¶æœº**ï¼šæ£€æµ‹ç”¨æˆ·æ´»è·ƒåº¦ï¼Œé€‰æ‹©åˆé€‚æ—¶é—´
-   **æ•°æ®è¿ç§»ç­–ç•¥**ï¼šå°†æ´»åŠ¨æ•°æ®è¿ç§»åˆ°å¸¸è§„æµç¨‹
-   **å­˜å‚¨ç©ºé—´è®¡ç®—**ï¼šç»Ÿè®¡æ’ä»¶å ç”¨ç©ºé—´ï¼Œæç¤ºç”¨æˆ·
-   **å›æ»šæœºåˆ¶**ï¼šä¿ç•™å¤‡ä»½ï¼Œæ”¯æŒå¿«é€Ÿæ¢å¤

**å®ç°éš¾ç‚¹**ï¼š

-   å®‰å…¨å¸è½½ï¼Œé¿å…æ•°æ®ä¸¢å¤±
-   ç”¨æˆ·ä½“éªŒä¼˜åŒ–
-   èµ„æºæ¸…ç†çš„å®Œæ•´æ€§

* * *

## ğŸ“‹ ä¸ƒä¸ªæ ¸å¿ƒä¸šåŠ¡åœºæ™¯ä»‹ç»

### 1.Â **åŠ¨æ€åŠ è½½APKï¼Œæ–°å¢Activity**Â -Â **åŒ11é™æ—¶ç§’æ€æ´»åŠ¨**

**ä¸šåŠ¡åœºæ™¯**ï¼šåŒ11å½“å¤©0ç‚¹ï¼Œéœ€è¦ä¸Šçº¿å…¨æ–°çš„ã€Œé™æ—¶ç§’æ€ã€æ´»åŠ¨é¡µé¢ï¼ŒåŒ…å«å€’è®¡æ—¶ã€åº“å­˜ç§’æ€ã€å¼¹å¹•äº’åŠ¨ç­‰å¤æ‚åŠŸèƒ½ã€‚ä¼ ç»Ÿå‘ç‰ˆéœ€ç­‰å¾…åº”ç”¨å•†åº—å®¡æ ¸ï¼Œè€Œæ’ä»¶åŒ–å¯ä»¥å®ç°ï¼š

-   11æœˆ10æ—¥23:50 æå‰é¢„åŠ è½½ç§’æ€æ’ä»¶
-   11æœˆ11æ—¥0:00 ç«‹å³æ¿€æ´»ç§’æ€é¡µé¢
-   é¡µé¢åŒ…å«ç‹¬ç«‹çš„æ´»åŠ¨é€»è¾‘ã€UIç»„ä»¶å’Œç½‘ç»œè¯·æ±‚
-   å¦‚æœæ´»åŠ¨å‡ºç°é—®é¢˜ï¼Œå¯éšæ—¶æ›¿æ¢æ–°ç‰ˆæ’ä»¶ï¼Œç”¨æˆ·æ— æ„ŸçŸ¥

**æŠ€æœ¯æŒ‘æˆ˜**ï¼šActivityå¯åŠ¨æœºåˆ¶ã€èµ„æºåŠ è½½ã€ç”Ÿå‘½å‘¨æœŸç®¡ç†

### 2.Â **çƒ­ä¿®å¤ä¸€ä¸ªç±»**Â -Â **ä¼˜æƒ åˆ¸å åŠ è®¡ç®—é€»è¾‘ç´§æ€¥ä¿®å¤**

**ä¸šåŠ¡åœºæ™¯**ï¼šåŒ11æœŸé—´å‘ç°ä¼˜æƒ åˆ¸å åŠ è®¡ç®—Bugï¼šæ»¡300å‡50çš„åº—é“ºåˆ¸ä¸æ»¡200å‡20çš„å¹³å°åˆ¸åŒæ—¶ä½¿ç”¨æ—¶ï¼Œè®¡ç®—é‡‘é¢é”™è¯¯ï¼Œå¯¼è‡´ç”¨æˆ·å¤šä»˜æˆ–å°‘ä»˜æ¬¾ã€‚éœ€è¦ï¼š

-   å®æ—¶å‘ç°çº¿ä¸ŠBugï¼ˆé€šè¿‡ç›‘æ§ç³»ç»Ÿï¼‰
-   å¿«é€Ÿå®šä½é—®é¢˜æ‰€åœ¨ç±»Â `CouponCalculator.java`
-   å¼€å‘ä¿®å¤ç‰ˆæœ¬ï¼Œç”Ÿæˆä¿®å¤Dexæ–‡ä»¶
-   é€šè¿‡åå°é…ç½®ç³»ç»Ÿï¼Œå‘æ‰€æœ‰ç”¨æˆ·æ¨é€çƒ­ä¿®å¤åŒ…
-   ç”¨æˆ·ä¸‹æ¬¡æ‰“å¼€è´­ç‰©è½¦æ—¶è‡ªåŠ¨åº”ç”¨ä¿®å¤ï¼Œæ— éœ€é‡å¯App

**æŠ€æœ¯æŒ‘æˆ˜**ï¼šClassLoaderæœºåˆ¶ã€Dexæ–‡ä»¶åŠ è½½ã€ç±»æ›¿æ¢å…¼å®¹æ€§

### 3.Â **çƒ­ä¿®å¤æ›¿æ¢èµ„æºæ–‡ä»¶**Â -Â **æ´»åŠ¨å›¾ç‰‡/æ–‡æ¡ˆç´§æ€¥æ›´æ¢**

**ä¸šåŠ¡åœºæ™¯**ï¼š

1.  **ç‰ˆæƒé—®é¢˜**ï¼šå‘ç°æ´»åŠ¨ä¸»å›¾ä¾µçŠ¯ç‰ˆæƒï¼Œéœ€ç«‹å³æ›´æ¢
1.  **ç´§æ€¥è°ƒæ•´**ï¼šæ´»åŠ¨æ–‡æ¡ˆæ¶‰åŠæ•æ„Ÿè¯ï¼Œéœ€ç«‹å³ä¿®æ”¹
1.  **A/Bæµ‹è¯•**ï¼šæµ‹è¯•ä¸åŒBannerå›¾çš„ç‚¹å‡»ç‡ï¼Œéœ€åŠ¨æ€åˆ‡æ¢
1.  **èŠ‚æ—¥æ›´æ–°**ï¼šä»é¢„çƒ­æœŸâ†’é«˜å³°æœŸâ†’è¿”åœºæœŸï¼Œè§†è§‰é£æ ¼éœ€è¦æ¸å˜åˆ‡æ¢

**æŠ€æœ¯æŒ‘æˆ˜**ï¼šèµ„æºIDå†²çªã€å¤šè¯­è¨€æ”¯æŒã€å›¾ç‰‡ç¼“å­˜æ›´æ–°

### 4.Â **çƒ­ä¿®å¤ä¸€ä¸ªSOåº“**Â -Â **å›¾ç‰‡åŠ è½½åº“æ€§èƒ½ä¼˜åŒ–**

**ä¸šåŠ¡åœºæ™¯**ï¼šåŒ11æœŸé—´å›¾ç‰‡åŠ è½½é‡å‰§å¢ï¼Œå‘ç°ï¼š

1.  WebPè§£ç åº“åœ¨é«˜å¹¶å‘ä¸‹å´©æºƒç‡å¢åŠ 3%
1.  GIFåŠ¨å›¾åº“å†…å­˜æ³„æ¼ï¼Œå¯¼è‡´OOM
1.  å›¾ç‰‡å‹ç¼©ç®—æ³•æ•ˆç‡ä½ï¼ŒåŠ è½½é€Ÿåº¦æ…¢
1.  éœ€è¦ç´§æ€¥æ›¿æ¢ä¸ºä¼˜åŒ–åçš„Nativeåº“

**è§£å†³æ–¹æ¡ˆ**ï¼šåœ¨ä¸å‘ç‰ˆçš„æƒ…å†µä¸‹ï¼ŒåŠ¨æ€æ›¿æ¢Â `libimage_decoder.so`Â åº“æ–‡ä»¶

**æŠ€æœ¯æŒ‘æˆ˜**ï¼šä¸åŒCPUæ¶æ„é€‚é…ã€ç¬¦å·è¡¨å…¼å®¹ã€åŠ è½½æ—¶æœº

### 5.Â **å¤šæ’ä»¶ç®¡ç†ä¸çƒ­æ›´æ–°**Â -Â **å…¨é“¾è·¯è´­ç‰©æµç¨‹æ’ä»¶åŒ–**

**ä¸šåŠ¡åœºæ™¯**ï¼šåŒ11æœŸé—´ï¼Œæ•´ä¸ªè´­ç‰©æµç¨‹éœ€è¦ç‰¹æ®Šå¤„ç†ï¼š

1.  **è´­ç‰©è½¦æ’ä»¶**ï¼šæ”¯æŒé¢„å”®ã€æ»¡å‡ã€è·¨åº—æ»¡å‡ç­‰å¤æ‚è®¡ç®—
1.  **ä¸‹å•æ’ä»¶**ï¼šæ”¯æŒç»„åˆä¼˜æƒ ã€çº¢åŒ…ã€è´­ç‰©é‡‘ç­‰ç‰¹æ®Šé€»è¾‘
1.  **æ”¯ä»˜æ’ä»¶**ï¼šå¯¹æ¥é“¶è¡Œä¸´æ—¶ä¼˜æƒ ã€åˆ†æœŸå…æ¯æ´»åŠ¨
1.  **ç‰©æµæ’ä»¶**ï¼šåŒ11ä¸“å±ç‰©æµè·Ÿè¸ªã€é¢„çº¦é…é€

**æ›´æ–°ç­–ç•¥**ï¼š

-   ç°åº¦å‘å¸ƒï¼šå…ˆ10%ç”¨æˆ·ï¼Œå†50%ï¼Œæœ€å100%
-   ç‰ˆæœ¬å›æ»šï¼š5åˆ†é’Ÿå†…å¯å›é€€åˆ°ç¨³å®šç‰ˆæœ¬
-   å¼€å…³æ§åˆ¶ï¼šåå°å¯éšæ—¶å…³é—­é—®é¢˜æ’ä»¶

**æŠ€æœ¯æŒ‘æˆ˜**ï¼šæ’ä»¶ä¾èµ–ç®¡ç†ã€ç‰ˆæœ¬å…¼å®¹ã€å¹¶å‘åŠ è½½

### 6.Â **é«˜æ•ˆé€šä¿¡**Â -Â **æ’ä»¶ä¸å®¿ä¸»æ·±åº¦é›†æˆ**

**ä¸šåŠ¡åœºæ™¯**ï¼šæ’ä»¶éœ€è¦ä¸å®¿ä¸»æ— ç¼åä½œï¼š

1.  **ç”¨æˆ·ä¿¡æ¯**ï¼šæ’ä»¶éœ€è¦è·å–ç™»å½•çŠ¶æ€ã€æ”¶è´§åœ°å€
1.  **è´­ç‰©è½¦åŒæ­¥**ï¼šæ’ä»¶æ·»åŠ å•†å“ï¼Œå®¿ä¸»è´­ç‰©è½¦å®æ—¶æ›´æ–°
1.  **æ”¯ä»˜å›è°ƒ**ï¼šæ’ä»¶å‘èµ·æ”¯ä»˜ï¼Œå®¿ä¸»å¤„ç†æ”¯ä»˜ç»“æœ
1.  **æ•°æ®åŸ‹ç‚¹**ï¼šæ’ä»¶äº‹ä»¶éœ€è¦ç»Ÿä¸€ä¸ŠæŠ¥åˆ°å®¿ä¸»åˆ†æç³»ç»Ÿ
1.  **FragmentåµŒå…¥**ï¼šåœ¨å®¿ä¸»é¡µé¢ä¸­åµŒå…¥æ’ä»¶åŒ–çš„æ´»åŠ¨ä¸“åŒº

**æŠ€æœ¯æŒ‘æˆ˜**ï¼šè·¨è¿›ç¨‹é€šä¿¡ã€æ•°æ®ä¸€è‡´æ€§ã€æ€§èƒ½ä¼˜åŒ–

### 7.Â **æ´»åŠ¨ç»“æŸå¸è½½**Â -Â **åŒ11åèµ„æºæ¸…ç†**

**ä¸šåŠ¡åœºæ™¯**ï¼š11æœˆ12æ—¥00:00æ´»åŠ¨ç»“æŸï¼š

1.  **ç©ºé—´å›æ”¶**ï¼šåˆ é™¤ä¸´æ—¶æ’ä»¶ï¼Œé‡Šæ”¾50-100MBå­˜å‚¨ç©ºé—´
1.  **åŠŸèƒ½é™çº§**ï¼šæ¢å¤å¸¸è§„è´­ç‰©æµç¨‹ï¼Œç§»é™¤åŒ11ç‰¹æ®Šé€»è¾‘
1.  **æ•°æ®è¿ç§»**ï¼šå°†æ´»åŠ¨æœŸé—´çš„è´­ç‰©è½¦æ•°æ®è¿ç§»åˆ°å¸¸è§„æµç¨‹
1.  **ç›‘æ§æ¸…ç†**ï¼šåœæ­¢æ´»åŠ¨æœŸé—´çš„ä¸“é¡¹ç›‘æ§
1.  **ç”¨æˆ·é€šçŸ¥**ï¼šæé†’ç”¨æˆ·æ´»åŠ¨ç»“æŸï¼Œå¼•å¯¼æŸ¥çœ‹è®¢å•

**æŠ€æœ¯æŒ‘æˆ˜**ï¼šå®‰å…¨å¸è½½ã€çŠ¶æ€ä¿å­˜ã€ç”¨æˆ·ä½“éªŒ

* * *

## ğŸ”§ å®Œæ•´Demoå®ç°

### **é¡¹ç›®ç»“æ„**

text

```
EcommerceDouble11/
â”œâ”€â”€ app/                            # å®¿ä¸»åº”ç”¨
â”œâ”€â”€ plugin-manager/                 # æ’ä»¶ç®¡ç†å™¨
â”œâ”€â”€ plugin-sdk/                     # å®¿ä¸»æ’ä»¶é€šä¿¡SDK
â”œâ”€â”€ plugins/                        # æ’ä»¶é›†åˆ
â”‚   â”œâ”€â”€ promotion-double11/         # åŒ11æ´»åŠ¨ä¸»æ’ä»¶
â”‚   â”œâ”€â”€ shopping-cart-double11/     # åŒ11è´­ç‰©è½¦æ’ä»¶
â”‚   â”œâ”€â”€ flash-sale/                 # é™æ—¶ç§’æ€æ’ä»¶
â”‚   â”œâ”€â”€ coupon-manager/             # ä¼˜æƒ åˆ¸ç®¡ç†æ’ä»¶
â”‚   â””â”€â”€ payment-double11/           # åŒ11æ”¯ä»˜æ’ä»¶
â”œâ”€â”€ hotfix/                         # çƒ­ä¿®å¤æ¨¡å—
â”œâ”€â”€ update-manager/                 # æ›´æ–°ç®¡ç†å™¨
â””â”€â”€ buildSrc/                       # æ„å»ºè„šæœ¬
```

### **1. åŠ¨æ€åŠ è½½APKï¼šåŒ11é™æ—¶ç§’æ€æ´»åŠ¨**

#### **FlashSalePlugin.java**

java

```
package com.taobao.double11.plugin.flashsale;

import android.app.Activity;
import android.content.Context;
import android.os.Bundle;
import android.view.LayoutInflater;
import android.view.View;
import android.widget.Button;
import android.widget.TextView;
import android.widget.Toast;
import java.util.concurrent.Executors;
import java.util.concurrent.ScheduledExecutorService;
import java.util.concurrent.TimeUnit;

/**
 * é™æ—¶ç§’æ€æ´»åŠ¨æ’ä»¶
 * åŒ11æœŸé—´ç‹¬ç«‹å¼€å‘çš„ç§’æ€æ¨¡å—ï¼ŒåŒ…å«å€’è®¡æ—¶ã€åº“å­˜ç®¡ç†ã€æŠ¢è´­é€»è¾‘
 */
public class FlashSalePlugin {

    private Activity hostActivity;
    private Context pluginContext;
    private TextView countdownView;
    private TextView stockView;
    private Button buyButton;

    private ScheduledExecutorService scheduler;
    private long secondsRemaining = 3600; // 1å°æ—¶å€’è®¡æ—¶
    private int remainingStock = 1000;    // å‰©ä½™åº“å­˜

    // æ’ä»¶Activityçš„å…¥å£æ–¹æ³•
    public void onCreate(Bundle savedInstanceState) {
        if (hostActivity == null) {
            throw new IllegalStateException("Host activity not attached");
        }

        // åŠ è½½æ’ä»¶å¸ƒå±€
        int layoutId = getResourceId("activity_flash_sale", "layout");
        View view = LayoutInflater.from(hostActivity).inflate(layoutId, null);
        hostActivity.setContentView(view);

        initViews(view);
        initData();
        startCountdown();
    }

    private void initViews(View rootView) {
        countdownView = rootView.findViewById(getResourceId("tv_countdown", "id"));
        stockView = rootView.findViewById(getResourceId("tv_stock", "id"));
        buyButton = rootView.findViewById(getResourceId("btn_buy", "id"));

        // æŠ¢è´­æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        buyButton.setOnClickListener(v -> {
            if (remainingStock > 0) {
                attemptPurchase();
            } else {
                showToast("å•†å“å·²å”®ç½„ï¼");
            }
        });

        // åˆ†äº«æŒ‰é’®
        Button shareButton = rootView.findViewById(getResourceId("btn_share", "id"));
        shareButton.setOnClickListener(v -> shareToSocial());
    }

    private void initData() {
        // ä»å®¿ä¸»è·å–ç”¨æˆ·ä¿¡æ¯
        Bundle userInfo = callHostService("UserService", "getCurrentUser", null);
        if (userInfo != null && userInfo.getBoolean("isLogin")) {
            // å·²ç™»å½•ç”¨æˆ·
            String userId = userInfo.getString("userId");
            loadUserFlashSaleStatus(userId);
        } else {
            // æœªç™»å½•ï¼Œè·³è½¬ç™»å½•
            redirectToLogin();
        }

        // åŠ è½½å•†å“ä¿¡æ¯
        loadProductInfo();
    }

    private void startCountdown() {
        scheduler = Executors.newSingleThreadScheduledExecutor();
        scheduler.scheduleAtFixedRate(() -> {
            hostActivity.runOnUiThread(() -> {
                secondsRemaining--;
                updateCountdownDisplay();

                if (secondsRemaining <= 0) {
                    endFlashSale();
                }
            });
        }, 0, 1, TimeUnit.SECONDS);
    }

    private void updateCountdownDisplay() {
        long hours = secondsRemaining / 3600;
        long minutes = (secondsRemaining % 3600) / 60;
        long seconds = secondsRemaining % 60;

        String countdownText = String.format("%02d:%02d:%02d", hours, minutes, seconds);
        countdownView.setText(countdownText);
        stockView.setText("å‰©ä½™åº“å­˜: " + remainingStock);
    }

    private void attemptPurchase() {
        // è°ƒç”¨å®¿ä¸»æœåŠ¡æ£€æŸ¥è´­ä¹°èµ„æ ¼
        Bundle params = new Bundle();
        params.putString("productId", "double11_flash_001");
        params.putInt("quantity", 1);

        Bundle result = callHostService("PurchaseService", "checkQualification", params);

        if (result != null && result.getBoolean("canBuy")) {
            // æ‰£å‡åº“å­˜
            remainingStock--;
            updateCountdownDisplay();

            // è°ƒç”¨å®¿ä¸»ä¸‹å•æœåŠ¡
            placeOrder();
        } else {
            String reason = result.getString("reason", "è´­ä¹°å¤±è´¥");
            showToast(reason);
        }
    }

    private void placeOrder() {
        Bundle orderParams = new Bundle();
        orderParams.putString("productId", "double11_flash_001");
        orderParams.putString("activityType", "flash_sale");
        orderParams.putString("source", "double11_plugin");

        Bundle orderResult = callHostService("OrderService", "createFlashSaleOrder", orderParams);

        if (orderResult != null && orderResult.getBoolean("success")) {
            String orderId = orderResult.getString("orderId");
            showSuccessDialog(orderId);

            // ä¸ŠæŠ¥è´­ä¹°äº‹ä»¶
            trackEvent("flash_sale_purchase_success", orderParams);
        } else {
            // å›æ»šåº“å­˜
            remainingStock++;
            updateCountdownDisplay();
            showToast("ä¸‹å•å¤±è´¥ï¼Œè¯·é‡è¯•");
        }
    }

    private void endFlashSale() {
        if (scheduler != null) {
            scheduler.shutdown();
        }

        buyButton.setEnabled(false);
        buyButton.setText("æ´»åŠ¨å·²ç»“æŸ");
        countdownView.setText("00:00:00");

        // é€šçŸ¥å®¿ä¸»æ´»åŠ¨ç»“æŸ
        Bundle params = new Bundle();
        params.putString("activityId", "flash_sale_2023_double11");
        params.putString("status", "ended");
        callHostService("ActivityService", "notifyActivityEnd", params);
    }

    // ä¸å®¿ä¸»é€šä¿¡
    private Bundle callHostService(String serviceName, String method, Bundle params) {
        try {
            // é€šè¿‡æ’ä»¶SDKè°ƒç”¨å®¿ä¸»æœåŠ¡
            IHostServiceBridge bridge = Double11PluginManager.getServiceBridge();
            if (bridge != null) {
                return bridge.callHostService(serviceName, method, params);
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
        return null;
    }

    private int getResourceId(String name, String type) {
        try {
            // é€šè¿‡æ’ä»¶ç®¡ç†å™¨è·å–èµ„æºID
            return Double11PluginManager.getResourceId(name, type);
        } catch (Exception e) {
            e.printStackTrace();
            return 0;
        }
    }

    private void showToast(String message) {
        Toast.makeText(hostActivity, message, Toast.LENGTH_SHORT).show();
    }

    // ä¾›å®¿ä¸»è°ƒç”¨çš„æ–¹æ³•
    public void setHostActivity(Activity activity) {
        this.hostActivity = activity;
    }

    public void setPluginContext(Context context) {
        this.pluginContext = context;
    }

    @Override
    protected void finalize() throws Throwable {
        if (scheduler != null) {
            scheduler.shutdownNow();
        }
        super.finalize();
    }
}
```

#### **å¯åŠ¨ç§’æ€æ’ä»¶**

java

```
// å®¿ä¸»ä¸­å¯åŠ¨ç§’æ€æ’ä»¶
public class FlashSaleLauncher {

    public void startDouble11FlashSale(Context context) {
        // 1. æ£€æŸ¥æ’ä»¶æ˜¯å¦å·²å®‰è£…
        if (!PluginManager.hasPlugin("flash_sale_2023")) {
            // 2. åŠ¨æ€ä¸‹è½½æ’ä»¶
            downloadFlashSalePlugin();
        }

        // 3. åŠ è½½æ’ä»¶
        PluginLoadResult result = PluginManager.loadPlugin(
            "flash_sale_2023",
            "/data/data/com.taobao/files/plugins/flash_sale_v2.3.1.apk"
        );

        if (result.isSuccess()) {
            // 4. å¯åŠ¨ç§’æ€Activity
            Bundle extras = new Bundle();
            extras.putString("source", "home_banner");
            extras.putString("promotionId", "double11_2023");

            PluginManager.startPluginActivity(
                context,
                "flash_sale_2023",
                "com.taobao.double11.plugin.flashsale.FlashSalePlugin",
                extras
            );
        } else {
            // é™çº§æ–¹æ¡ˆï¼šè·³è½¬H5é¡µé¢
            fallbackToH5FlashSale();
        }
    }

    private void downloadFlashSalePlugin() {
        // å¼‚æ­¥ä¸‹è½½æ’ä»¶
        PluginDownloader downloader = new PluginDownloader();
        downloader.download(
            "https://cdn.taobao.com/plugins/double11/flash_sale_v2.3.1.apk",
            new PluginDownloadListener() {
                @Override
                public void onProgress(int progress) {
                    // æ˜¾ç¤ºä¸‹è½½è¿›åº¦
                }

                @Override
                public void onSuccess(File pluginFile) {
                    // ä¸‹è½½å®Œæˆï¼Œå®‰è£…æ’ä»¶
                    PluginManager.installPlugin("flash_sale_2023", pluginFile);
                }

                @Override
                public void onError(String error) {
                    // ä¸‹è½½å¤±è´¥ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ
                    fallbackToH5FlashSale();
                }
            }
        );
    }
}
```

### **2. çƒ­ä¿®å¤ç±»ï¼šä¼˜æƒ åˆ¸è®¡ç®—å™¨ä¿®å¤**

#### **CouponHotFixManager.java**

java

```
package com.taobao.double11.hotfix;

import android.content.Context;
import android.util.Log;
import java.io.File;
import java.io.FileOutputStream;
import java.io.InputStream;
import java.lang.reflect.Field;
import java.lang.reflect.Method;
import dalvik.system.DexClassLoader;

/**
 * ä¼˜æƒ åˆ¸è®¡ç®—é€»è¾‘çƒ­ä¿®å¤
 * ä¿®å¤åŒ11æœŸé—´å‘ç°çš„ä¼˜æƒ åˆ¸å åŠ è®¡ç®—Bug
 */
public class CouponHotFixManager {

    private static final String TAG = "CouponHotFix";
    private static final String FIXED_CLASS = "com.taobao.app.coupon.CouponCalculator";

    private Context context;

    public CouponHotFixManager(Context context) {
        this.context = context;
    }

    /**
     * åº”ç”¨ä¼˜æƒ åˆ¸è®¡ç®—çƒ­ä¿®å¤
     */
    public boolean applyCouponFix() {
        try {
            Log.i(TAG, "å¼€å§‹åº”ç”¨ä¼˜æƒ åˆ¸çƒ­ä¿®å¤...");

            // 1. ä¸‹è½½çƒ­ä¿®å¤åŒ…
            File hotfixDex = downloadHotfixDex();
            if (hotfixDex == null || !hotfixDex.exists()) {
                Log.e(TAG, "çƒ­ä¿®å¤æ–‡ä»¶ä¸å­˜åœ¨");
                return false;
            }

            // 2. éªŒè¯ç­¾å
            if (!verifySignature(hotfixDex)) {
                Log.e(TAG, "çƒ­ä¿®å¤æ–‡ä»¶ç­¾åéªŒè¯å¤±è´¥");
                return false;
            }

            // 3. åŠ è½½ä¿®å¤ç±»
            DexClassLoader dexClassLoader = createDexClassLoader(hotfixDex);
            Class<?> fixedClass = dexClassLoader.loadClass(FIXED_CLASS);

            // 4. æ›¿æ¢ç±»åŠ è½½å™¨ä¸­çš„ç±»
            boolean success = replaceClass(fixedClass);

            if (success) {
                Log.i(TAG, "ä¼˜æƒ åˆ¸çƒ­ä¿®å¤æˆåŠŸ");
                recordFixApplied();
                testFixResult();
                return true;
            }

        } catch (Exception e) {
            Log.e(TAG, "åº”ç”¨çƒ­ä¿®å¤å¤±è´¥", e);
        }

        return false;
    }

    /**
     * ä¿®å¤çš„Bugè¯¦æƒ…ï¼š
     * åŸå§‹Bugï¼šæ»¡300å‡50çš„åº—é“ºåˆ¸ä¸æ»¡200å‡20çš„å¹³å°åˆ¸å åŠ æ—¶ï¼Œè®¡ç®—é€»è¾‘é”™è¯¯
     * ä¿®å¤é€»è¾‘ï¼š
     * 1. ä¼˜å…ˆè®¡ç®—å¹³å°åˆ¸ï¼Œå†è®¡ç®—åº—é“ºåˆ¸
     * 2. å¢åŠ åˆ¸ä½¿ç”¨ä¼˜å…ˆçº§ç­–ç•¥
     * 3. ä¿®å¤é‡‘é¢è®¡ç®—ç²¾åº¦é—®é¢˜
     */
    private void testFixResult() {
        try {
            // è·å–ä¿®å¤åçš„ç±»
            Class<?> fixedCalculatorClass = Class.forName(FIXED_CLASS);
            Object calculator = fixedCalculatorClass.newInstance();

            // æµ‹è¯•ç”¨ä¾‹1ï¼š300å…ƒå•†å“ï¼Œä½¿ç”¨ä¸¤å¼ åˆ¸
            Method calculateMethod = fixedCalculatorClass.getMethod(
                "calculateFinalPrice",
                double.class, String[].class
            );

            double originalPrice = 300.0;
            String[] coupons = {"shop_300_50", "platform_200_20"};

            Double finalPrice = (Double) calculateMethod.invoke(
                calculator, originalPrice, coupons
            );

            Log.i(TAG, String.format("æµ‹è¯•ç»“æœ: åŸä»·%.2f, åˆ¸åä»·%.2f",
                originalPrice, finalPrice));

            // éªŒè¯ç»“æœæ˜¯å¦æ­£ç¡®
            if (Math.abs(finalPrice - 230.0) < 0.01) {
                Log.i(TAG, "çƒ­ä¿®å¤éªŒè¯é€šè¿‡ âœ“");
            } else {
                Log.e(TAG, "çƒ­ä¿®å¤éªŒè¯å¤±è´¥ âœ—");
            }

        } catch (Exception e) {
            Log.e(TAG, "æµ‹è¯•çƒ­ä¿®å¤ç»“æœå¤±è´¥", e);
        }
    }

    /**
     * ä¸‹è½½çƒ­ä¿®å¤Dexæ–‡ä»¶
     */
    private File downloadHotfixDex() {
        try {
            // ä»CDNä¸‹è½½çƒ­ä¿®å¤åŒ…
            String hotfixUrl = "https://cdn.taobao.com/hotfix/double11/coupon_fix_v1.2.dex";

            File hotfixDir = new File(context.getFilesDir(), "hotfix");
            if (!hotfixDir.exists()) {
                hotfixDir.mkdirs();
            }

            File hotfixFile = new File(hotfixDir, "coupon_calculator_fix.dex");

            // æ£€æŸ¥æœ¬åœ°æ˜¯å¦å·²æœ‰æœ€æ–°ç‰ˆæœ¬
            if (hotfixFile.exists() && isLatestVersion(hotfixFile)) {
                Log.i(TAG, "ä½¿ç”¨æœ¬åœ°ç¼“å­˜çš„çƒ­ä¿®å¤æ–‡ä»¶");
                return hotfixFile;
            }

            // ä¸‹è½½æ–°ç‰ˆæœ¬
            HotfixDownloader downloader = new HotfixDownloader();
            InputStream inputStream = downloader.download(hotfixUrl);

            FileOutputStream fos = new FileOutputStream(hotfixFile);
            byte[] buffer = new byte[8192];
            int bytesRead;

            while ((bytesRead = inputStream.read(buffer)) != -1) {
                fos.write(buffer, 0, bytesRead);
            }

            fos.close();
            inputStream.close();

            Log.i(TAG, "çƒ­ä¿®å¤æ–‡ä»¶ä¸‹è½½å®Œæˆ: " + hotfixFile.length() + " bytes");
            return hotfixFile;

        } catch (Exception e) {
            Log.e(TAG, "ä¸‹è½½çƒ­ä¿®å¤æ–‡ä»¶å¤±è´¥", e);
            return null;
        }
    }

    /**
     * ä½¿ç”¨åå°„æ›¿æ¢ç±»
     */
    private boolean replaceClass(Class<?> newClass) {
        try {
            // è·å–å½“å‰ClassLoader
            ClassLoader classLoader = getClass().getClassLoader();

            if (classLoader instanceof dalvik.system.BaseDexClassLoader) {
                dalvik.system.BaseDexClassLoader baseDexClassLoader =
                    (dalvik.system.BaseDexClassLoader) classLoader;

                // è·å–pathListå­—æ®µ
                Field pathListField = dalvik.system.BaseDexClassLoader.class
                    .getDeclaredField("pathList");
                pathListField.setAccessible(true);
                Object pathList = pathListField.get(baseDexClassLoader);

                // è·å–dexElementsæ•°ç»„
                Field dexElementsField = pathList.getClass()
                    .getDeclaredField("dexElements");
                dexElementsField.setAccessible(true);
                Object[] dexElements = (Object[]) dexElementsField.get(pathList);

                // åˆ›å»ºæ–°çš„dexElementsï¼Œå°†çƒ­ä¿®å¤dexæ”¾åœ¨æœ€å‰é¢
                Object[] newDexElements = createNewDexElements(dexElements, newClass);

                // æ›¿æ¢åŸæ•°ç»„
                dexElementsField.set(pathList, newDexElements);

                // æ¸…é™¤JITç¼“å­˜
                clearJitCache();

                return true;
            }

        } catch (Exception e) {
            Log.e(TAG, "æ›¿æ¢ç±»å¤±è´¥", e);
        }

        return false;
    }

    /**
     * åŒ11æœŸé—´æ‰¹é‡çƒ­ä¿®å¤
     */
    public void batchHotFixForDouble11() {
        String[] fixList = {
            "com.taobao.app.coupon.CouponCalculator",      // ä¼˜æƒ åˆ¸è®¡ç®—
            "com.taobao.app.cart.CartPriceCalculator",     // è´­ç‰©è½¦ä»·æ ¼è®¡ç®—
            "com.taobao.app.promotion.DiscountManager",    // æŠ˜æ‰£ç®¡ç†
            "com.taobao.app.order.OrderValidator",         // è®¢å•éªŒè¯
        };

        HotfixExecutor executor = new HotfixExecutor();
        executor.executeBatchFix(fixList, new HotfixCallback() {
            @Override
            public void onFixApplied(String className, boolean success) {
                Log.i(TAG, String.format("ä¿®å¤%s: %s",
                    className, success ? "æˆåŠŸ" : "å¤±è´¥"));

                // ä¸ŠæŠ¥çƒ­ä¿®å¤ç»“æœ
                HotfixReporter.report(className, success);

                if (!success) {
                    // å¤±è´¥æ—¶å¯ç”¨é™çº§æ–¹æ¡ˆ
                    enableFallbackForClass(className);
                }
            }

            @Override
            public void onAllComplete(int successCount, int totalCount) {
                Log.i(TAG, String.format("æ‰¹é‡çƒ­ä¿®å¤å®Œæˆ: %d/%d",
                    successCount, totalCount));

                // æ›´æ–°çƒ­ä¿®å¤çŠ¶æ€
                updateHotfixStatus(successCount, totalCount);
            }
        });
    }
}
```

#### **çƒ­ä¿®å¤é…ç½®æ–‡ä»¶**

json

```
// hotfix_config.json
{
  "hotfixes": [
    {
      "id": "coupon_calc_fix_20231101",
      "className": "com.taobao.app.coupon.CouponCalculator",
      "version": "1.2.0",
      "description": "ä¿®å¤åŒ11ä¼˜æƒ åˆ¸å åŠ è®¡ç®—é€»è¾‘é”™è¯¯",
      "downloadUrl": "https://cdn.taobao.com/hotfix/double11/coupon_fix_v1.2.dex",
      "md5": "a1b2c3d4e5f678901234567890123456",
      "minAppVersion": "9.5.0",
      "maxAppVersion": "9.8.0",
      "applyStrategy": {
        "type": "immediate",
        "conditions": ["wifi_only", "battery_high"],
        "rollbackOnFailure": true
      },
      "affectedUsers": "all",
      "releaseTime": "2023-11-01T10:00:00Z",
      "expireTime": "2023-11-15T23:59:59Z"
    }
  ]
}
```

### **3. çƒ­ä¿®å¤èµ„æºï¼šæ´»åŠ¨å›¾ç‰‡ç´§æ€¥æ›´æ¢**

#### **ResourceHotFixManager.java**

java

```
package com.taobao.double11.resource;

import android.content.Context;
import android.content.res.AssetManager;
import android.content.res.Resources;
import android.graphics.drawable.Drawable;
import android.util.DisplayMetrics;
import android.util.Log;
import java.io.File;
import java.io.FileOutputStream;
import java.io.InputStream;
import java.lang.reflect.Constructor;
import java.lang.reflect.Method;
import java.util.HashMap;
import java.util.Map;

/**
 * èµ„æºæ–‡ä»¶çƒ­ä¿®å¤ç®¡ç†å™¨
 * ç”¨äºç´§æ€¥æ›´æ¢æ´»åŠ¨å›¾ç‰‡ã€æ–‡æ¡ˆç­‰èµ„æº
 */
public class ResourceHotFixManager {

    private static final String TAG = "ResourceHotFix";

    private Context context;
    private AssetManager pluginAssetManager;
    private Resources pluginResources;
    private String pluginPackageName;

    private Map<String, Integer> resourceCache = new HashMap<>();

    public ResourceHotFixManager(Context context, String pluginApkPath) {
        this.context = context;
        this.pluginPackageName = extractPackageName(pluginApkPath);
        initPluginResources(pluginApkPath);
    }

    /**
     * åˆå§‹åŒ–æ’ä»¶èµ„æº
     */
    private void initPluginResources(String apkPath) {
        try {
            // 1. åˆ›å»ºæ’ä»¶çš„AssetManager
            pluginAssetManager = AssetManager.class.newInstance();

            // 2. åå°„è°ƒç”¨addAssetPathæ–¹æ³•
            Method addAssetPathMethod = AssetManager.class
                .getDeclaredMethod("addAssetPath", String.class);
            addAssetPathMethod.setAccessible(true);

            // 3. æ·»åŠ æ’ä»¶APKè·¯å¾„
            int cookie = (int) addAssetPathMethod.invoke(pluginAssetManager, apkPath);

            if (cookie == 0) {
                Log.e(TAG, "æ·»åŠ æ’ä»¶èµ„æºè·¯å¾„å¤±è´¥");
                return;
            }

            // 4. æ·»åŠ çƒ­ä¿®å¤èµ„æºè·¯å¾„
            File hotfixResDir = new File(context.getFilesDir(), "hotfix_res");
            if (hotfixResDir.exists()) {
                addAssetPathMethod.invoke(pluginAssetManager, hotfixResDir.getAbsolutePath());
            }

            // 5. åˆ›å»ºResourceså¯¹è±¡
            Resources hostResources = context.getResources();
            pluginResources = new Resources(
                pluginAssetManager,
                hostResources.getDisplayMetrics(),
                hostResources.getConfiguration()
            );

            Log.i(TAG, "æ’ä»¶èµ„æºåˆå§‹åŒ–æˆåŠŸ");

        } catch (Exception e) {
            Log.e(TAG, "åˆå§‹åŒ–æ’ä»¶èµ„æºå¤±è´¥", e);
            pluginResources = context.getResources();
        }
    }

    /**
     * çƒ­ä¿®å¤å•ä¸ªèµ„æºæ–‡ä»¶
     */
    public boolean hotFixResource(String resourceType, String resourceName,
                                 InputStream newResourceStream) {
        try {
            // 1. åˆ›å»ºçƒ­ä¿®å¤èµ„æºç›®å½•
            File hotfixDir = new File(context.getFilesDir(), "hotfix_res");
            File typeDir = new File(hotfixDir, resourceType);

            if (!typeDir.exists()) {
                typeDir.mkdirs();
            }

            // 2. ä¿å­˜æ–°çš„èµ„æºæ–‡ä»¶
            File targetFile = new File(typeDir, resourceName);
            FileOutputStream fos = new FileOutputStream(targetFile);

            byte[] buffer = new byte[8192];
            int bytesRead;
            while ((bytesRead = newResourceStream.read(buffer)) != -1) {
                fos.write(buffer, 0, bytesRead);
            }

            fos.close();
            newResourceStream.close();

            // 3. é‡æ–°åŠ è½½èµ„æº
            reloadResources();

            // 4. éªŒè¯èµ„æºæ˜¯å¦ç”Ÿæ•ˆ
            boolean verified = verifyResource(resourceType, resourceName);

            Log.i(TAG, String.format("èµ„æºçƒ­ä¿®å¤%s: %s/%s",
                verified ? "æˆåŠŸ" : "å¤±è´¥", resourceType, resourceName));

            return verified;

        } catch (Exception e) {
            Log.e(TAG, "çƒ­ä¿®å¤èµ„æºå¤±è´¥", e);
            return false;
        }
    }

    /**
     * é‡æ–°åŠ è½½èµ„æº
     */
    private void reloadResources() {
        try {
            // é‡æ–°åˆ›å»ºResourceså¯¹è±¡
            Resources hostResources = context.getResources();
            pluginResources = new Resources(
                pluginAssetManager,
                hostResources.getDisplayMetrics(),
                hostResources.getConfiguration()
            );

            // æ¸…é™¤èµ„æºç¼“å­˜
            resourceCache.clear();

            // é€šçŸ¥UIæ›´æ–°
            notifyResourceChanged();

        } catch (Exception e) {
            Log.e(TAG, "é‡æ–°åŠ è½½èµ„æºå¤±è´¥", e);
        }
    }

    /**
     * è·å–æ’ä»¶Drawableï¼ˆé¿å…ä¸å®¿ä¸»å†²çªï¼‰
     */
    public Drawable getPluginDrawable(String resourceName) {
        try {
            int resId = getResourceId(resourceName, "drawable");
            if (resId != 0) {
                return pluginResources.getDrawable(resId);
            }
        } catch (Exception e) {
            Log.e(TAG, "è·å–Drawableå¤±è´¥: " + resourceName, e);
        }
        return null;
    }

    /**
     * è·å–æ’ä»¶String
     */
    public String getPluginString(String resourceName) {
        try {
            int resId = getResourceId(resourceName, "string");
            if (resId != 0) {
                return pluginResources.getString(resId);
            }
        } catch (Exception e) {
            Log.e(TAG, "è·å–Stringå¤±è´¥: " + resourceName, e);
        }
        return "";
    }

    /**
     * è·å–æ’ä»¶Color
     */
    public int getPluginColor(String resourceName) {
        try {
            int resId = getResourceId(resourceName, "color");
            if (resId != 0) {
                return pluginResources.getColor(resId);
            }
        } catch (Exception e) {
            Log.e(TAG, "è·å–Colorå¤±è´¥: " + resourceName, e);
        }
        return 0;
    }

    /**
     * è·å–èµ„æºIDï¼ˆå¸¦ç¼“å­˜ï¼‰
     */
    private int getResourceId(String resourceName, String resourceType) {
        String cacheKey = resourceType + "_" + resourceName;

        if (resourceCache.containsKey(cacheKey)) {
            return resourceCache.get(cacheKey);
        }

        try {
            int resId = pluginResources.getIdentifier(
                resourceName,
                resourceType,
                pluginPackageName
            );

            resourceCache.put(cacheKey, resId);
            return resId;

        } catch (Exception e) {
            Log.e(TAG, "è·å–èµ„æºIDå¤±è´¥: " + resourceName, e);
            return 0;
        }
    }

    /**
     * åŒ11åœºæ™¯ï¼šç´§æ€¥æ›´æ¢æ´»åŠ¨ä¸»å›¾
     */
    public void emergencyReplaceBanner() {
        Log.i(TAG, "å¼€å§‹ç´§æ€¥æ›´æ¢æ´»åŠ¨ä¸»å›¾...");

        // 1. ä¸‹è½½æ–°çš„Bannerå›¾ç‰‡
        InputStream bannerStream = downloadResource(
            "https://cdn.taobao.com/double11/banners/new_banner_v2.png",
            "double11_main_banner.png"
        );

        if (bannerStream != null) {
            // 2. çƒ­ä¿®å¤drawableèµ„æº
            boolean success = hotFixResource(
                "drawable",
                "double11_main_banner.png",
                bannerStream
            );

            if (success) {
                // 3. æ›´æ–°æ‰€æœ‰ç›¸å…³æ–‡æ¡ˆ
                updatePromotionTexts();

                // 4. ä¸ŠæŠ¥æ›´æ¢ç»“æœ
                reportResourceUpdate("double11_main_banner", success);
            }
        }

        // 5. æ¸…ç†æ—§çš„å›¾ç‰‡ç¼“å­˜
        clearImageCache();
    }

    /**
     * A/Bæµ‹è¯•ï¼šåŠ¨æ€åˆ‡æ¢Bannerå›¾
     */
    public void switchBannerForABTest(String experimentGroup) {
        String bannerName;

        switch (experimentGroup) {
            case "group_a":
                bannerName = "banner_version_a.png";
                break;
            case "group_b":
                bannerName = "banner_version_b.png";
                break;
            case "group_c":
                bannerName = "banner_version_c.png";
                break;
            default:
                bannerName = "banner_default.png";
        }

        // åŠ è½½å¯¹åº”ç‰ˆæœ¬çš„Banner
        InputStream bannerStream = loadLocalBanner(bannerName);
        if (bannerStream != null) {
            hotFixResource("drawable", "double11_main_banner.png", bannerStream);

            // è®°å½•å®éªŒæ›å…‰
            trackExperimentExposure(experimentGroup, bannerName);
        }
    }

    /**
     * èµ„æºå†²çªå¤„ç†ï¼šä¸ºæ’ä»¶èµ„æºæ·»åŠ å‰ç¼€
     */
    public int getPluginResourceId(String originalName, String type) {
        // ä¸ºæ’ä»¶èµ„æºæ·»åŠ å‰ç¼€ï¼Œé¿å…ä¸å®¿ä¸»å†²çª
        String pluginPrefix = "plugin_" + pluginPackageName.replace('.', '_') + "_";
        String prefixedName = pluginPrefix + originalName;

        int resId = getResourceId(prefixedName, type);
        if (resId == 0) {
            // å¦‚æœæ²¡æœ‰å‰ç¼€ç‰ˆæœ¬ï¼Œå°è¯•åŸå§‹åç§°
            resId = getResourceId(originalName, type);
        }
        return resId;
    }

    private String extractPackageName(String apkPath) {
        // ä»APKè·¯å¾„æå–åŒ…å
        // å®é™…å®ç°éœ€è¦è§£æAPKçš„Manifest
        return "com.taobao.double11.plugin";
    }
}
```

### **4. çƒ­ä¿®å¤SOåº“ï¼šå›¾ç‰‡åŠ è½½ä¼˜åŒ–**

#### **SoHotFixManager.java**

java

```
package com.taobao.double11.nativefix;

import android.content.Context;
import android.os.Build;
import android.system.ErrnoException;
import android.system.Os;
import android.util.Log;
import java.io.File;
import java.io.FileOutputStream;
import java.io.InputStream;
import java.lang.reflect.Field;
import java.util.ArrayList;
import java.util.List;
import java.util.zip.ZipEntry;
import java.util.zip.ZipInputStream;

/**
 * SOåº“çƒ­ä¿®å¤ç®¡ç†å™¨
 * ç”¨äºä¼˜åŒ–å›¾ç‰‡åŠ è½½åº“æ€§èƒ½
 */
public class SoHotFixManager {

    private static final String TAG = "SoHotFix";

    private Context context;
    private List<String> loadedLibs = new ArrayList<>();

    public SoHotFixManager(Context context) {
        this.context = context;
    }

    /**
     * çƒ­ä¿®å¤SOåº“
     */
    public boolean hotFixSoLibrary(String libName, InputStream soStream) {
        try {
            Log.i(TAG, "å¼€å§‹çƒ­ä¿®å¤SOåº“: " + libName);

            // 1. éªŒè¯SOæ–‡ä»¶
            byte[] soData = validateSoFile(soStream, libName);
            if (soData == null) {
                Log.e(TAG, "SOæ–‡ä»¶éªŒè¯å¤±è´¥");
                return false;
            }

            // 2. è·å–CPUæ¶æ„
            String cpuArch = getCpuArchitecture();

            // 3. ä¿å­˜SOæ–‡ä»¶åˆ°çƒ­ä¿®å¤ç›®å½•
            File hotfixLibFile = saveSoToHotfixDir(libName, cpuArch, soData);
            if (hotfixLibFile == null) {
                return false;
            }

            // 4. è®¾ç½®å¯æ‰§è¡Œæƒé™
            setExecutablePermission(hotfixLibFile);

            // 5. æ·»åŠ åˆ°Native Library Path
            addToLibraryPath(hotfixLibFile.getParent());

            // 6. é‡æ–°åŠ è½½SOåº“
            boolean success = reloadLibrary(libName);

            if (success) {
                Log.i(TAG, "SOåº“çƒ­ä¿®å¤æˆåŠŸ: " + libName);

                // 7. éªŒè¯æ€§èƒ½æå‡
                verifyPerformanceImprovement(libName);

                // 8. è®°å½•çƒ­ä¿®å¤çŠ¶æ€
                recordSoFixStatus(libName, true);

                return true;
            }

        } catch (Exception e) {
            Log.e(TAG, "çƒ­ä¿®å¤SOåº“å¤±è´¥: " + libName, e);
        }

        return false;
    }

    /**
     * éªŒè¯SOæ–‡ä»¶
     */
    private byte[] validateSoFile(InputStream inputStream, String libName) {
        try {
            // è¯»å–æ•´ä¸ªæ–‡ä»¶åˆ°å†…å­˜
            ByteArrayOutputStream baos = new ByteArrayOutputStream();
            byte[] buffer = new byte[8192];
            int bytesRead;

            while ((bytesRead = inputStream.read(buffer)) != -1) {
                baos.write(buffer, 0, bytesRead);
            }

            byte[] soData = baos.toByteArray();

            // 1. æ£€æŸ¥æ–‡ä»¶å¤§å°
            if (soData.length == 0 || soData.length > 10 * 1024 * 1024) {
                Log.e(TAG, "SOæ–‡ä»¶å¤§å°å¼‚å¸¸: " + soData.length);
                return null;
            }

            // 2. æ£€æŸ¥ELFå¤´
            if (!isValidElfFile(soData)) {
                Log.e(TAG, "æ— æ•ˆçš„ELFæ–‡ä»¶");
                return null;
            }

            // 3. æ£€æŸ¥æ¶æ„åŒ¹é…
            if (!checkArchitectureMatch(soData)) {
                Log.e(TAG, "SOæ–‡ä»¶æ¶æ„ä¸åŒ¹é…");
                return null;
            }

            // 4. æ£€æŸ¥æ•°å­—ç­¾åï¼ˆå¯é€‰ï¼‰
            if (!verifySoSignature(soData)) {
                Log.w(TAG, "SOæ–‡ä»¶ç­¾åéªŒè¯å¤±è´¥ï¼ˆç»§ç»­åŠ è½½ï¼‰");
            }

            return soData;

        } catch (Exception e) {
            Log.e(TAG, "éªŒè¯SOæ–‡ä»¶å¤±è´¥", e);
            return null;
        }
    }

    /**
     * è·å–CPUæ¶æ„
     */
    private String getCpuArchitecture() {
        // æ”¯æŒçš„ä¸»è¦æ¶æ„
        String[] supportedABIs = Build.SUPPORTED_ABIS;

        // ä¼˜å…ˆé€‰æ‹©64ä½æ¶æ„
        for (String abi : supportedABIs) {
            if (abi.contains("arm64") || abi.contains("x86_64")) {
                return abi;
            }
        }

        // å›é€€åˆ°ç¬¬ä¸€ä¸ªæ”¯æŒçš„ABI
        return supportedABIs.length > 0 ? supportedABIs[0] : "armeabi-v7a";
    }

    /**
     * ä¿å­˜SOæ–‡ä»¶åˆ°çƒ­ä¿®å¤ç›®å½•
     */
    private File saveSoToHotfixDir(String libName, String cpuArch, byte[] soData) {
        try {
            // åˆ›å»ºçƒ­ä¿®å¤ç›®å½•
            File hotfixBaseDir = new File(context.getFilesDir(), "hotfix_libs");
            File archDir = new File(hotfixBaseDir, cpuArch);

            if (!archDir.exists()) {
                archDir.mkdirs();
            }

            // ç”ŸæˆSOæ–‡ä»¶å
            String soFileName = System.mapLibraryName(libName);
            File soFile = new File(archDir, soFileName + ".hotfix");

            // åˆ é™¤æ—§ç‰ˆæœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (soFile.exists()) {
                soFile.delete();
            }

            // å†™å…¥SOæ–‡ä»¶
            FileOutputStream fos = new FileOutputStream(soFile);
            fos.write(soData);
            fos.close();

            Log.i(TAG, "SOæ–‡ä»¶ä¿å­˜æˆåŠŸ: " + soFile.getAbsolutePath());
            return soFile;

        } catch (Exception e) {
            Log.e(TAG, "ä¿å­˜SOæ–‡ä»¶å¤±è´¥", e);
            return null;
        }
    }

    /**
     * è®¾ç½®å¯æ‰§è¡Œæƒé™
     */
    private void setExecutablePermission(File soFile) {
        try {
            // è®¾ç½®è¯»ã€å†™ã€æ‰§è¡Œæƒé™
            soFile.setReadable(true, false);
            soFile.setWritable(true, false);
            soFile.setExecutable(true, false);

            // ä½¿ç”¨Os.chmodè®¾ç½®æƒé™
            Os.chmod(soFile.getAbsolutePath(), 0755);

        } catch (ErrnoException e) {
            Log.w(TAG, "è®¾ç½®æ–‡ä»¶æƒé™å¤±è´¥", e);
        }
    }

    /**
     * æ·»åŠ åˆ°Native Library Path
     */
    private void addToLibraryPath(String libPath) {
        try {
            // è·å–å½“å‰ClassLoaderçš„nativeLibraryDirectories
            ClassLoader classLoader = context.getClassLoader();
            Field nativeLibraryDirectoriesField = ClassLoader.class
                .getDeclaredField("nativeLibraryDirectories");
            nativeLibraryDirectoriesField.setAccessible(true);

            List<File> nativeLibraryDirectories = (List<File>)
                nativeLibraryDirectoriesField.get(classLoader);

            // æ·»åŠ çƒ­ä¿®å¤ç›®å½•åˆ°æœ€å‰é¢
            nativeLibraryDirectories.add(0, new File(libPath));

            // æ›´æ–°å­—æ®µ
            nativeLibraryDirectoriesField.set(classLoader, nativeLibraryDirectories);

            Log.i(TAG, "å·²æ·»åŠ åº“è·¯å¾„: " + libPath);

        } catch (Exception e) {
            Log.e(TAG, "æ·»åŠ åº“è·¯å¾„å¤±è´¥", e);
        }
    }

    /**
     * é‡æ–°åŠ è½½SOåº“
     */
    private boolean reloadLibrary(String libName) {
        try {
            // 1. å…ˆå°è¯•å¸è½½ï¼ˆå¦‚æœå·²åŠ è½½ï¼‰
            try {
                System.loadLibrary(libName + "_hotfix");
            } catch (UnsatisfiedLinkError e) {
                // æœªåŠ è½½è¿‡ï¼Œç»§ç»­
            }

            // 2. åŠ è½½çƒ­ä¿®å¤ç‰ˆæœ¬
            System.loadLibrary(libName + "_hotfix");

            // 3. æ›´æ–°å·²åŠ è½½åº“åˆ—è¡¨
            loadedLibs.add(libName);

            Log.i(TAG, "åŠ è½½çƒ­ä¿®å¤SOåº“æˆåŠŸ: " + libName);
            return true;

        } catch (UnsatisfiedLinkError e) {
            Log.e(TAG, "åŠ è½½çƒ­ä¿®å¤SOåº“å¤±è´¥: " + libName, e);

            // 4. é™çº§ï¼šå°è¯•åŠ è½½åŸå§‹ç‰ˆæœ¬
            try {
                System.loadLibrary(libName);
                Log.w(TAG, "å›é€€åˆ°åŸå§‹SOåº“: " + libName);
                return false;
            } catch (UnsatisfiedLinkError e2) {
                Log.e(TAG, "åŠ è½½åŸå§‹SOåº“ä¹Ÿå¤±è´¥: " + libName, e2);
                return false;
            }
        }
    }

    /**
     * éªŒè¯æ€§èƒ½æå‡
     */
    private void verifyPerformanceImprovement(String libName) {
        Log.i(TAG, "å¼€å§‹éªŒè¯" + libName + "æ€§èƒ½æå‡...");

        long startTime = System.currentTimeMillis();

        try {
            // æ‰§è¡Œæ€§èƒ½æµ‹è¯•
            if (libName.equals("image_processor")) {
                testImageProcessorPerformance();
            } else if (libName.equals("gif_decoder")) {
                testGifDecoderPerformance();
            } else if (libName.equals("webp_decoder")) {
                testWebpDecoderPerformance();
            }

            long elapsedTime = System.currentTimeMillis() - startTime;

            Log.i(TAG, String.format("%s æ€§èƒ½æµ‹è¯•è€—æ—¶: %dms", libName, elapsedTime));

            // ä¸ŠæŠ¥æ€§èƒ½æ•°æ®
            reportPerformanceMetrics(libName, elapsedTime);

        } catch (Exception e) {
            Log.e(TAG, "æ€§èƒ½æµ‹è¯•å¤±è´¥", e);
        }
    }

    /**
     * åŒ11æœŸé—´æ‰¹é‡ä¼˜åŒ–å›¾ç‰‡å¤„ç†åº“
     */
    public void optimizeImageLibsForDouble11() {
        Log.i(TAG, "åŒ11æœŸé—´å¼€å§‹ä¼˜åŒ–å›¾ç‰‡å¤„ç†åº“...");

        String[] libsToOptimize = {
            "image_processor",      // å›¾ç‰‡å¤„ç†å™¨
            "gif_decoder",         // GIFè§£ç å™¨
            "webp_decoder",        // WebPè§£ç å™¨
            "jpeg_turbo",          // JPEG Turboè§£ç å™¨
            "png_decoder"          // PNGè§£ç å™¨
        };

        int successCount = 0;

        for (String libName : libsToOptimize) {
            try {
                // ä¸‹è½½ä¼˜åŒ–åçš„SOåº“
                InputStream soStream = downloadOptimizedSo(libName);
                if (soStream != null) {
                    boolean success = hotFixSoLibrary(libName, soStream);
                    if (success) {
                        successCount++;
                    }
                }
            } catch (Exception e) {
                Log.e(TAG, "ä¼˜åŒ–" + libName + "å¤±è´¥", e);
            }
        }

        Log.i(TAG, String.format("å›¾ç‰‡åº“ä¼˜åŒ–å®Œæˆ: %d/%d æˆåŠŸ",
            successCount, libsToOptimize.length));

        // æ›´æ–°é…ç½®
        if (successCount > 0) {
            enableOptimizedImagePipeline();
        }
    }
}
```

### **5. å¤šæ’ä»¶ç®¡ç†ä¸çƒ­æ›´æ–°**

#### **Double11PluginManager.java**

java

```
package com.taobao.double11.plugin;

import android.content.Context;
import android.content.SharedPreferences;
import android.util.Log;
import java.io.File;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.Future;

/**
 * åŒ11å¤šæ’ä»¶ç®¡ç†å™¨
 * ç®¡ç†è´­ç‰©æµç¨‹çš„å„ä¸ªæ’ä»¶ï¼Œæ”¯æŒç‰ˆæœ¬æ§åˆ¶å’Œçƒ­æ›´æ–°
 */
public class Double11PluginManager {

    private static final String TAG = "Double11PluginManager";
    private static final String PLUGIN_CONFIG = "double11_plugins_config";

    private static Double11PluginManager instance;

    private Context context;
    private SharedPreferences prefs;
    private ExecutorService pluginExecutor;

    // æ’ä»¶çŠ¶æ€å­˜å‚¨
    private Map<String, PluginInfo> pluginRegistry = new ConcurrentHashMap<>();
    private Map<String, PluginState> pluginStates = new ConcurrentHashMap<>();

    // æ’ä»¶ä¾èµ–å…³ç³»
    private Map<String, List<String>> pluginDependencies = new HashMap<>();

    private Double11PluginManager(Context context) {
        this.context = context.getApplicationContext();
        this.prefs = context.getSharedPreferences(PLUGIN_CONFIG, Context.MODE_PRIVATE);
        this.pluginExecutor = Executors.newFixedThreadPool(3);

        initPluginDependencies();
        loadPluginConfigs();
    }

    public static synchronized Double11PluginManager getInstance(Context context) {
        if (instance == null) {
            instance = new Double11PluginManager(context);
        }
        return instance;
    }

    /**
     * åˆå§‹åŒ–æ’ä»¶ä¾èµ–å…³ç³»
     */
    private void initPluginDependencies() {
        // å®šä¹‰åŒ11è´­ç‰©æµç¨‹æ’ä»¶ä¾èµ–
        pluginDependencies.put("promotion_main", new ArrayList<>());  // ä¸»æ´»åŠ¨æ’ä»¶

        List<String> cartDeps = new ArrayList<>();
        cartDeps.add("promotion_main");
        pluginDependencies.put("shopping_cart", cartDeps);  // è´­ç‰©è½¦æ’ä»¶

        List<String> orderDeps = new ArrayList<>();
        orderDeps.add("shopping_cart");
        pluginDependencies.put("order_checkout", orderDeps);  // ä¸‹å•æ’ä»¶

        List<String> paymentDeps = new ArrayList<>();
        paymentDeps.add("order_checkout");
        pluginDependencies.put("payment", paymentDeps);  // æ”¯ä»˜æ’ä»¶
    }

    /**
     * åŠ è½½å¤šä¸ªæ’ä»¶
     */
    public void loadMultiplePlugins(List<PluginConfig> configs) {
        Log.i(TAG, "å¼€å§‹åŠ è½½å¤šä¸ªæ’ä»¶ï¼Œæ•°é‡: " + configs.size());

        // 1. æŒ‰ä¼˜å…ˆçº§æ’åº
        configs.sort((c1, c2) -> Integer.compare(c2.priority, c1.priority));

        // 2. å¹¶è¡ŒåŠ è½½é«˜ä¼˜å…ˆçº§æ’ä»¶
        List<Future<PluginLoadResult>> futures = new ArrayList<>();

        for (PluginConfig config : configs) {
            if (config.priority >= 8) {  // é«˜ä¼˜å…ˆçº§æ’ä»¶
                Future<PluginLoadResult> future = pluginExecutor.submit(() -> {
                    return loadSinglePlugin(config);
                });
                futures.add(future);
            }
        }

        // 3. ç­‰å¾…é«˜ä¼˜å…ˆçº§æ’ä»¶åŠ è½½å®Œæˆ
        waitForHighPriorityPlugins(futures);

        // 4. ä¸²è¡ŒåŠ è½½ä¸­ä¼˜å…ˆçº§æ’ä»¶
        for (PluginConfig config : configs) {
            if (config.priority >= 5 && config.priority < 8) {
                loadSinglePlugin(config);
            }
        }

        // 5. åå°åŠ è½½ä½ä¼˜å…ˆçº§æ’ä»¶
        for (PluginConfig config : configs) {
            if (config.priority < 5) {
                pluginExecutor.submit(() -> {
                    loadSinglePlugin(config);
                });
            }
        }

        Log.i(TAG, "å¤šæ’ä»¶åŠ è½½æµç¨‹å®Œæˆ");
    }

    /**
     * åŠ è½½å•ä¸ªæ’ä»¶
     */
    private PluginLoadResult loadSinglePlugin(PluginConfig config) {
        try {
            Log.i(TAG, "åŠ è½½æ’ä»¶: " + config.pluginId + " v" + config.version);

            // 1. æ£€æŸ¥ä¾èµ–
            if (!checkDependencies(config.pluginId)) {
                return PluginLoadResult.error("ä¾èµ–æ’ä»¶æœªåŠ è½½");
            }

            // 2. æ£€æŸ¥ç‰ˆæœ¬å…¼å®¹æ€§
            if (!isVersionCompatible(config)) {
                return PluginLoadResult.error("ç‰ˆæœ¬ä¸å…¼å®¹");
            }

            // 3. æ£€æŸ¥æ’ä»¶æ–‡ä»¶
            File pluginFile = new File(config.pluginPath);
            if (!pluginFile.exists()) {
                return PluginLoadResult.error("æ’ä»¶æ–‡ä»¶ä¸å­˜åœ¨");
            }

            // 4. éªŒè¯ç­¾å
            if (!verifyPluginSignature(pluginFile, config.expectedSignature)) {
                return PluginLoadResult.error("æ’ä»¶ç­¾åéªŒè¯å¤±è´¥");
            }

            // 5. åˆ›å»ºæ’ä»¶ä¿¡æ¯
            PluginInfo pluginInfo = new PluginInfo(
                config.pluginId,
                config.version,
                pluginFile.getAbsolutePath(),
                config.priority,
                System.currentTimeMillis()
            );

            // 6. åŠ è½½æ’ä»¶åˆ°Shadowæ¡†æ¶
            ShadowLoadResult shadowResult = ShadowPluginLoader.loadPlugin(pluginInfo);
            if (!shadowResult.success) {
                return PluginLoadResult.error(shadowResult.errorMessage);
            }

            // 7. æ³¨å†Œæ’ä»¶
            pluginRegistry.put(config.pluginId, pluginInfo);
            pluginStates.put(config.pluginId, PluginState.LOADED);

            // 8. ä¿å­˜é…ç½®
            savePluginConfig(pluginInfo);

            // 9. è§¦å‘æ’ä»¶åŠ è½½å®Œæˆäº‹ä»¶
            notifyPluginLoaded(config.pluginId);

            Log.i(TAG, "æ’ä»¶åŠ è½½æˆåŠŸ: " + config.pluginId);
            return PluginLoadResult.success(pluginInfo);

        } catch (Exception e) {
            Log.e(TAG, "åŠ è½½æ’ä»¶å¤±è´¥: " + config.pluginId, e);
            return PluginLoadResult.error(e.getMessage());
        }
    }

    /**
     * æ£€æŸ¥æ’ä»¶ä¾èµ–
     */
    private boolean checkDependencies(String pluginId) {
        List<String> dependencies = pluginDependencies.get(pluginId);
        if (dependencies == null || dependencies.isEmpty()) {
            return true;
        }

        for (String depId : dependencies) {
            PluginState state = pluginStates.get(depId);
            if (state == null || state != PluginState.LOADED) {
                Log.w(TAG, "æ’ä»¶" + pluginId + "çš„ä¾èµ–" + depId + "æœªåŠ è½½");
                return false;
            }
        }

        return true;
    }

    /**
     * åŒ11çƒ­æ›´æ–°ç­–ç•¥
     */
    public class Double11UpdateStrategy {

        private static final String UPDATE_SERVER = "https://plugin-update.taobao.com";

        /**
         * æ£€æŸ¥å¹¶æ›´æ–°æ‰€æœ‰åŒ11æ’ä»¶
         */
        public void checkAndUpdateAllPlugins() {
            Log.i(TAG, "æ£€æŸ¥åŒ11æ’ä»¶æ›´æ–°...");

            // 1. ä»æœåŠ¡å™¨è·å–æœ€æ–°æ’ä»¶åˆ—è¡¨
            List<PluginUpdateInfo> updateList = fetchUpdateListFromServer();

            // 2. æ ¹æ®ç½‘ç»œæ¡ä»¶é€‰æ‹©æ›´æ–°ç­–ç•¥
            UpdateStrategy strategy = selectUpdateStrategy();

            // 3. æ‰§è¡Œæ›´æ–°
            switch (strategy) {
                case IMMEDIATE:
                    updateImmediately(updateList);
                    break;

                case WIFI_ONLY:
                    if (NetworkUtils.isWifiConnected(context)) {
                        updateImmediately(updateList);
                    } else {
                        scheduleWifiUpdate(updateList);
                    }
                    break;

                case BACKGROUND:
                    updateInBackground(updateList);
                    break;

                case SCHEDULED:
                    scheduleUpdate(updateList);
                    break;
            }

            // 4. è®°å½•æ›´æ–°æ—¶é—´
            updateLastCheckTime();
        }

        /**
         * ç°åº¦æ›´æ–°ç­–ç•¥
         */
        public void canaryUpdate(String pluginId, String newVersion) {
            // 1. æ ¹æ®ç”¨æˆ·IDåˆ†ç»„
            String userId = getUserService().getCurrentUserId();
            int userGroup = calculateUserGroup(userId, 100);  // åˆ†æˆ100ç»„

            // 2. é€æ­¥æ”¾é‡
            if (userGroup < 10) {  // 10%ç”¨æˆ·
                updatePluginForGroup(pluginId, newVersion, "canary_group_1");
            } else if (userGroup < 30) {  // 20%ç”¨æˆ·
                updatePluginForGroup(pluginId, newVersion, "canary_group_2");
            } else if (userGroup < 60) {  // 30%ç”¨æˆ·
                updatePluginForGroup(pluginId, newVersion, "canary_group_3");
            } else {  // 40%ç”¨æˆ·
                updatePluginForGroup(pluginId, newVersion, "canary_group_4");
            }

            // 3. ç›‘æ§å„ç»„çš„æ€§èƒ½æ•°æ®
            monitorCanaryGroups(pluginId);
        }

        /**
         * ç´§æ€¥å›æ»šç­–ç•¥
         */
        public void emergencyRollback(String pluginId) {
            Log.w(TAG, "æ‰§è¡Œç´§æ€¥å›æ»š: " + pluginId);

            // 1. åœæ­¢æ’ä»¶æ‰€æœ‰æœåŠ¡
            stopPluginServices(pluginId);

            // 2. å¸è½½é—®é¢˜ç‰ˆæœ¬
            unloadPlugin(pluginId);

            // 3. æ¢å¤å¤‡ä»½ç‰ˆæœ¬
            restoreBackupVersion(pluginId);

            // 4. é‡æ–°åŠ è½½ç¨³å®šç‰ˆæœ¬
            loadStableVersion(pluginId);

            // 5. å‘é€å›æ»šé€šçŸ¥
            sendRollbackNotification(pluginId);

            // 6. åˆ†æé—®é¢˜åŸå› 
            analyzeRollbackReason(pluginId);
        }

        /**
         * åŒ11æœŸé—´çš„ç‰¹æ®Šæ›´æ–°ç­–ç•¥
         */
        public void double11SpecialUpdate() {
            Log.i(TAG, "æ‰§è¡ŒåŒ11ç‰¹æ®Šæ›´æ–°ç­–ç•¥");

            // 1. é¢„çƒ­é˜¶æ®µï¼ˆ11æœˆ1æ—¥-10æ—¥ï¼‰
            if (isPreheatingPeriod()) {
                preloadDouble11Plugins();
                applyPreheatingUpdates();
            }

            // 2. é«˜å³°æœŸï¼ˆ11æœˆ11æ—¥ï¼‰
            if (isPeakPeriod()) {
                // æš‚åœéå…³é”®æ›´æ–°
                pauseNonCriticalUpdates();

                // å‡†å¤‡ç´§æ€¥ä¿®å¤åŒ…
                prepareEmergencyFixes();

                // å¯ç”¨å¿«é€Ÿå›æ»šé€šé“
                enableQuickRollbackChannel();
            }

            // 3. è¿”åœºæœŸï¼ˆ11æœˆ12æ—¥-15æ—¥ï¼‰
            if (isReturnPeriod()) {
                applyPostPeakUpdates();
                cleanupTemporaryPlugins();
            }
        }
    }

    /**
     * å®¿ä¸»ä¸æ’ä»¶ç‰ˆæœ¬å…¼å®¹æ€§ç®¡ç†
     */
    public class VersionCompatibilityManager {

        /**
         * æ£€æŸ¥æ’ä»¶ä¸å®¿ä¸»çš„å…¼å®¹æ€§
         */
        public boolean checkCompatibility(String pluginId, String pluginVersion,
                                         String hostVersion) {
            PluginVersionInfo pluginVer = parseVersion(pluginVersion);
            PluginVersionInfo hostVer = parseVersion(hostVersion);

            // 1. ä¸»è¦ç‰ˆæœ¬å¿…é¡»ç›¸åŒ
            if (pluginVer.major != hostVer.major) {
                Log.w(TAG, "ä¸»è¦ç‰ˆæœ¬ä¸åŒ¹é…: æ’ä»¶" + pluginVer.major +
                      " vs å®¿ä¸»" + hostVer.major);
                return false;
            }

            // 2. æ’ä»¶æ¬¡è¦ç‰ˆæœ¬ä¸èƒ½é«˜äºå®¿ä¸»
            if (pluginVer.minor > hostVer.minor) {
                Log.w(TAG, "æ’ä»¶æ¬¡è¦ç‰ˆæœ¬è¿‡é«˜: æ’ä»¶" + pluginVer.minor +
                      " vs å®¿ä¸»" + hostVer.minor);
                return false;
            }

            // 3. æ£€æŸ¥ç‰¹æ®Šç‰ˆæœ¬è¦æ±‚
            PluginRequirement requirement = getPluginRequirement(pluginId);
            if (requirement != null) {
                if (!checkRequirement(requirement, hostVersion)) {
                    return false;
                }
            }

            // 4. æ£€æŸ¥APIå…¼å®¹æ€§
            if (!checkApiCompatibility(pluginId)) {
                return false;
            }

            return true;
        }

        /**
         * åŒ11æœŸé—´æ”¾å®½ç‰ˆæœ¬é™åˆ¶
         */
        public void relaxVersionConstraintsForDouble11() {
            if (isDouble11Period()) {
                Log.i(TAG, "åŒ11æœŸé—´æ”¾å®½ç‰ˆæœ¬é™åˆ¶");

                // å…è®¸æ’ä»¶ä½¿ç”¨æ›´é«˜ç‰ˆæœ¬
                enableForwardCompatibility();

                // å…è®¸ç°åº¦å‘å¸ƒå®éªŒæ€§ç‰ˆæœ¬
                enableExperimentalReleases();

                // å¯ç”¨è‡ªåŠ¨é™çº§æœºåˆ¶
                enableAutoDowngrade();
            }
        }
    }
}
```

### **6. å®¿ä¸»ä¸æ’ä»¶é€šä¿¡**

#### **Double11CommunicationBridge.java**

java

```
package com.taobao.double11.communication;

import android.content.Context;
import android.os.Bundle;
import android.os.Handler;
import android.os.Looper;
import android.util.Log;
import java.lang.reflect.Method;
import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

/**
 * å®¿ä¸»ä¸æ’ä»¶é€šä¿¡æ¡¥æ¢
 * æ”¯æŒåŒå‘è°ƒç”¨ã€äº‹ä»¶ç›‘å¬ã€æ•°æ®å…±äº«
 */
public class Double11CommunicationBridge {

    private static final String TAG = "CommunicationBridge";

    private static Double11CommunicationBridge instance;

    private Context hostContext;
    private ExecutorService communicationExecutor;
    private Handler mainHandler;

    // å®¿ä¸»æœåŠ¡æ³¨å†Œè¡¨
    private Map<String, Object> hostServices = new ConcurrentHashMap<>();

    // æ’ä»¶æœåŠ¡æ³¨å†Œè¡¨
    private Map<String, Object> pluginServices = new ConcurrentHashMap<>();

    // äº‹ä»¶ç›‘å¬å™¨
    private Map<String, List<EventListener>> eventListeners = new ConcurrentHashMap<>();

    // å…±äº«æ•°æ®å­˜å‚¨
    private Map<String, Object> sharedData = new ConcurrentHashMap<>();

    private Double11CommunicationBridge(Context context) {
        this.hostContext = context.getApplicationContext();
        this.communicationExecutor = Executors.newFixedThreadPool(4);
        this.mainHandler = new Handler(Looper.getMainLooper());

        registerDefaultHostServices();
    }

    public static synchronized Double11CommunicationBridge getInstance(Context context) {
        if (instance == null) {
            instance = new Double11CommunicationBridge(context);
        }
        return instance;
    }

    /**
     * æ³¨å†Œé»˜è®¤å®¿ä¸»æœåŠ¡
     */
    private void registerDefaultHostServices() {
        // ç”¨æˆ·æœåŠ¡
        registerHostService("UserService", new HostUserService());

        // è´­ç‰©è½¦æœåŠ¡
        registerHostService("CartService", new HostCartService());

        // è®¢å•æœåŠ¡
        registerHostService("OrderService", new HostOrderService());

        // æ”¯ä»˜æœåŠ¡
        registerHostService("PaymentService", new HostPaymentService());

        // æ´»åŠ¨æœåŠ¡
        registerHostService("ActivityService", new HostActivityService());

        Log.i(TAG, "é»˜è®¤å®¿ä¸»æœåŠ¡æ³¨å†Œå®Œæˆ");
    }

    /**
     * æ³¨å†Œå®¿ä¸»æœåŠ¡
     */
    public void registerHostService(String serviceName, Object service) {
        hostServices.put(serviceName, service);
        Log.i(TAG, "æ³¨å†Œå®¿ä¸»æœåŠ¡: " + serviceName);
    }

    /**
     * æ³¨å†Œæ’ä»¶æœåŠ¡
     */
    public void registerPluginService(String pluginId, String serviceName, Object service) {
        String fullServiceName = pluginId + "." + serviceName;
        pluginServices.put(fullServiceName, service);
        Log.i(TAG, "æ³¨å†Œæ’ä»¶æœåŠ¡: " + fullServiceName);
    }

    /**
     * æ’ä»¶è°ƒç”¨å®¿ä¸»æœåŠ¡
     */
    public Bundle callHostService(String serviceName, String method, Bundle params) {
        try {
            Log.d(TAG, "æ’ä»¶è°ƒç”¨å®¿ä¸»æœåŠ¡: " + serviceName + "." + method);

            Object service = hostServices.get(serviceName);
            if (service == null) {
                return createErrorResult("å®¿ä¸»æœåŠ¡ä¸å­˜åœ¨: " + serviceName);
            }

            // æŸ¥æ‰¾æ–¹æ³•
            Method targetMethod = findMethod(service.getClass(), method, params);
            if (targetMethod == null) {
                return createErrorResult("æ–¹æ³•ä¸å­˜åœ¨: " + method);
            }

            // æ‰§è¡Œæ–¹æ³•
            Object result = targetMethod.invoke(service, convertBundleToParams(params));

            // åŒ…è£…ç»“æœ
            return convertResultToBundle(result);

        } catch (Exception e) {
            Log.e(TAG, "è°ƒç”¨å®¿ä¸»æœåŠ¡å¤±è´¥", e);
            return createErrorResult(e.getMessage());
        }
    }

    /**
     * å®¿ä¸»è°ƒç”¨æ’ä»¶æœåŠ¡
     */
    public Bundle callPluginService(String pluginId, String serviceName,
                                   String method, Bundle params) {
        try {
            String fullServiceName = pluginId + "." + serviceName;
            Log.d(TAG, "å®¿ä¸»è°ƒç”¨æ’ä»¶æœåŠ¡: " + fullServiceName + "." + method);

            Object service = pluginServices.get(fullServiceName);
            if (service == null) {
                return createErrorResult("æ’ä»¶æœåŠ¡ä¸å­˜åœ¨: " + fullServiceName);
            }

            // æŸ¥æ‰¾æ–¹æ³•
            Method targetMethod = findMethod(service.getClass(), method, params);
            if (targetMethod == null) {
                return createErrorResult("æ–¹æ³•ä¸å­˜åœ¨: " + method);
            }

            // æ‰§è¡Œæ–¹æ³•
            Object result = targetMethod.invoke(service, convertBundleToParams(params));

            // åŒ…è£…ç»“æœ
            return convertResultToBundle(result);

        } catch (Exception e) {
            Log.e(TAG, "è°ƒç”¨æ’ä»¶æœåŠ¡å¤±è´¥", e);
            return createErrorResult(e.getMessage());
        }
    }

    /**
     * æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨
     */
    public void registerEventListener(String event, EventListener listener) {
        List<EventListener> listeners = eventListeners.get(event);
        if (listeners == null) {
            listeners = new ArrayList<>();
            eventListeners.put(event, listeners);
        }
        listeners.add(listener);
    }

    /**
     * å‘é€äº‹ä»¶
     */
    public void sendEvent(String event, Bundle data) {
        List<EventListener> listeners = eventListeners.get(event);
        if (listeners != null) {
            for (EventListener listener : listeners) {
                listener.onEvent(event, data);
            }
        }
    }

    /**
     * è®¾ç½®å…±äº«æ•°æ®
     */
    public void setSharedData(String key, Object value) {
        sharedData.put(key, value);

        // é€šçŸ¥æ•°æ®å˜åŒ–
        Bundle data = new Bundle();
        data.putString("key", key);
        data.putString("action", "update");
        sendEvent("shared_data_changed", data);
    }

    /**
     * è·å–å…±äº«æ•°æ®
     */
    public Object getSharedData(String key) {
        return sharedData.get(key);
    }

    /**
     * åŒ11è´­ç‰©è½¦åŒæ­¥ç¤ºä¾‹
     */
    public void syncCartBetweenHostAndPlugin(String pluginId) {
        Log.i(TAG, "åŒæ­¥è´­ç‰©è½¦æ•°æ®...");

        // 1. ä»å®¿ä¸»è·å–è´­ç‰©è½¦æ•°æ®
        Bundle cartParams = new Bundle();
        cartParams.putBoolean("includePromotion", true);

        Bundle hostCartResult = callHostService("CartService",
            "getCartItems", cartParams);

        if (hostCartResult.getBoolean("success")) {
            // 2. åŒæ­¥åˆ°æ’ä»¶
            Bundle syncParams = new Bundle();
            syncParams.putBundle("cartData", hostCartResult);

            Bundle pluginResult = callPluginService(pluginId,
                "ShoppingCartService", "syncCartData", syncParams);

            if (pluginResult.getBoolean("success")) {
                Log.i(TAG, "è´­ç‰©è½¦åŒæ­¥æˆåŠŸ");
            } else {
                Log.w(TAG, "è´­ç‰©è½¦åŒæ­¥å¤±è´¥");
            }
        }
    }

    /**
     * ä½¿ç”¨Fragmentæ‰¿è½½æ’ä»¶UI
     */
    public PluginFragment getPluginFragment(String pluginId,
                                          String fragmentName,
                                          Bundle args) {
        try {
            Log.i(TAG, "åŠ è½½æ’ä»¶Fragment: " + fragmentName);

            // 1. è·å–æ’ä»¶ClassLoader
            ClassLoader pluginClassLoader = PluginManager.getClassLoader(pluginId);

            // 2. åŠ è½½Fragmentç±»
            Class<?> fragmentClass = pluginClassLoader.loadClass(fragmentName);

            // 3. åˆ›å»ºFragmentå®ä¾‹
            Object fragmentObj = fragmentClass.newInstance();

            // 4. è®¾ç½®å‚æ•°
            if (args != null) {
                Method setArgumentsMethod = fragmentClass.getMethod("setArguments", Bundle.class);
                setArgumentsMethod.invoke(fragmentObj, args);
            }

            // 5. æ³¨å…¥é€šä¿¡æ¡¥
            Method setBridgeMethod = fragmentClass.getMethod(
                "setCommunicationBridge", Double11CommunicationBridge.class);
            setBridgeMethod.invoke(fragmentObj, this);

            return (PluginFragment) fragmentObj;

        } catch (Exception e) {
            Log.e(TAG, "åŠ è½½æ’ä»¶Fragmentå¤±è´¥", e);
            return null;
        }
    }
}

/**
 * å®¿ä¸»ç”¨æˆ·æœåŠ¡å®ç°
 */
class HostUserService {

    public Bundle getCurrentUser(Bundle params) {
        Bundle result = new Bundle();

        try {
            // è·å–å½“å‰ç™»å½•ç”¨æˆ·
            User currentUser = UserManager.getInstance().getCurrentUser();

            if (currentUser != null) {
                result.putBoolean("isLogin", true);
                result.putString("userId", currentUser.getId());
                result.putString("userName", currentUser.getName());
                result.putString("avatar", currentUser.getAvatar());
                result.putString("vipLevel", currentUser.getVipLevel());
                result.putBoolean("hasShippingAddress", currentUser.hasShippingAddress());
                result.putBoolean("success", true);
            } else {
                result.putBoolean("isLogin", false);
                result.putBoolean("success", true);
            }

        } catch (Exception e) {
            result.putBoolean("success", false);
            result.putString("error", e.getMessage());
        }

        return result;
    }

    public Bundle updateUserInfo(Bundle params) {
        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
        return new Bundle();
    }
}

/**
 * å®¿ä¸»è´­ç‰©è½¦æœåŠ¡å®ç°
 */
class HostCartService {

    public Bundle getCartItems(Bundle params) {
        Bundle result = new Bundle();

        try {
            // è·å–è´­ç‰©è½¦å•†å“
            List<CartItem> cartItems = CartManager.getInstance().getCartItems();

            // è½¬æ¢ä¸ºBundleæ ¼å¼
            ArrayList<Bundle> itemBundles = new ArrayList<>();
            for (CartItem item : cartItems) {
                Bundle itemBundle = new Bundle();
                itemBundle.putString("id", item.getId());
                itemBundle.putString("name", item.getName());
                itemBundle.putDouble("price", item.getPrice());
                itemBundle.putInt("quantity", item.getQuantity());
                itemBundle.putString("image", item.getImageUrl());
                itemBundles.add(itemBundle);
            }

            result.putParcelableArrayList("items", itemBundles);
            result.putDouble("totalPrice", CartManager.calculateTotal(cartItems));
            result.putInt("totalItems", cartItems.size());
            result.putBoolean("success", true);

        } catch (Exception e) {
            result.putBoolean("success", false);
            result.putString("error", e.getMessage());
        }

        return result;
    }

    public Bundle addToCart(Bundle params) {
        // æ·»åŠ å•†å“åˆ°è´­ç‰©è½¦
        return new Bundle();
    }
}
```

### **7. æ´»åŠ¨ç»“æŸå¸è½½æ’ä»¶**

#### **Double11PluginCleaner.java**

java

```
package com.taobao.double11.cleanup;

import android.content.Context;
import android.content.SharedPreferences;
import android.os.AsyncTask;
import android.util.Log;
import java.io.File;
import java.util.ArrayList;
import java.util.List;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

/**
 * åŒ11æ´»åŠ¨ç»“æŸåçš„æ’ä»¶æ¸…ç†å™¨
 * è´Ÿè´£å®‰å…¨å¸è½½æ’ä»¶ã€æ¸…ç†èµ„æºã€æ¢å¤é»˜è®¤é…ç½®
 */
public class Double11PluginCleaner {

    private static final String TAG = "PluginCleaner";
    private static final String CLEANUP_CONFIG = "double11_cleanup_status";

    private Context context;
    private SharedPreferences prefs;
    private ExecutorService cleanupExecutor;

    // æ’ä»¶æ¸…ç†çŠ¶æ€
    private enum CleanupStatus {
        NOT_STARTED,
        IN_PROGRESS,
        COMPLETED,
        FAILED
    }

    public Double11PluginCleaner(Context context) {
        this.context = context.getApplicationContext();
        this.prefs = context.getSharedPreferences(CLEANUP_CONFIG, Context.MODE_PRIVATE);
        this.cleanupExecutor = Executors.newSingleThreadExecutor();
    }

    /**
     * åŒ11æ´»åŠ¨ç»“æŸåçš„å®Œæ•´æ¸…ç†æµç¨‹
     */
    public void completeDouble11Cleanup() {
        Log.i(TAG, "å¼€å§‹åŒ11æ´»åŠ¨åæ¸…ç†...");

        // 1. æ£€æŸ¥æ´»åŠ¨æ˜¯å¦çœŸçš„ç»“æŸ
        if (!isDouble11ReallyOver()) {
            Log.i(TAG, "åŒ11æ´»åŠ¨å°šæœªå®Œå…¨ç»“æŸï¼Œå»¶è¿Ÿæ¸…ç†");
            scheduleDelayedCleanup(24 * 60 * 60 * 1000); // 24å°æ—¶å
            return;
        }

        // 2. å¼‚æ­¥æ‰§è¡Œæ¸…ç†
        new CleanupTask().execute();
    }

    /**
     * æ¸…ç†ä»»åŠ¡
     */
    private class CleanupTask extends AsyncTask<Void, Integer, Boolean> {

        @Override
        protected void onPreExecute() {
            super.onPreExecute();

            // æ˜¾ç¤ºæ¸…ç†æç¤º
            showCleanupNotification("æ­£åœ¨æ¸…ç†åŒ11æ´»åŠ¨èµ„æº...");

            // æ›´æ–°æ¸…ç†çŠ¶æ€
            updateCleanupStatus(CleanupStatus.IN_PROGRESS);
        }

        @Override
        protected Boolean doInBackground(Void... voids) {
            try {
                publishProgress(0);

                // 1. åœæ­¢æ‰€æœ‰æ’ä»¶æœåŠ¡
                stopAllPluginServices();
                publishProgress(10);

                // 2. å¸è½½åŒ11æ’ä»¶
                unloadDouble11Plugins();
                publishProgress(30);

                // 3. æ¸…ç†æ’ä»¶æ–‡ä»¶
                cleanupPluginFiles();
                publishProgress(50);

                // 4. æ¸…ç†ç¼“å­˜æ•°æ®
                cleanupPluginCache();
                publishProgress(70);

                // 5. æ¢å¤é»˜è®¤é…ç½®
                restoreDefaultConfig();
                publishProgress(90);

                // 6. ä¼˜åŒ–å­˜å‚¨ç©ºé—´
                optimizeStorage();
                publishProgress(100);

                return true;

            } catch (Exception e) {
                Log.e(TAG, "æ¸…ç†ä»»åŠ¡å¤±è´¥", e);
                return false;
            }
        }

        @Override
        protected void onProgressUpdate(Integer... progress) {
            // æ›´æ–°è¿›åº¦
            updateProgressNotification(progress[0]);
        }

        @Override
        protected void onPostExecute(Boolean success) {
            if (success) {
                Log.i(TAG, "åŒ11æ´»åŠ¨æ¸…ç†å®Œæˆ");

                // æ›´æ–°çŠ¶æ€
                updateCleanupStatus(CleanupStatus.COMPLETED);

                // æ˜¾ç¤ºå®Œæˆé€šçŸ¥
                showCleanupCompleteNotification();

                // ç”Ÿæˆæ¸…ç†æŠ¥å‘Š
                generateCleanupReport();

                // ä¸ŠæŠ¥æ¸…ç†å®Œæˆ
                reportCleanupComplete();

            } else {
                Log.e(TAG, "åŒ11æ´»åŠ¨æ¸…ç†å¤±è´¥");

                // æ›´æ–°çŠ¶æ€
                updateCleanupStatus(CleanupStatus.FAILED);

                // æ˜¾ç¤ºå¤±è´¥é€šçŸ¥
                showCleanupFailedNotification();

                // è®°å½•å¤±è´¥åŸå› 
                recordCleanupFailure();
            }
        }
    }

    /**
     * å¸è½½åŒ11æ’ä»¶
     */
    private void unloadDouble11Plugins() {
        Log.i(TAG, "å¼€å§‹å¸è½½åŒ11æ’ä»¶...");

        // è·å–æ‰€æœ‰åŒ11æ’ä»¶
        List<String> double11Plugins = getDouble11PluginIds();

        for (String pluginId : double11Plugins) {
            try {
                safeUnloadPlugin(pluginId);
                Log.i(TAG, "å¸è½½æ’ä»¶æˆåŠŸ: " + pluginId);

            } catch (Exception e) {
                Log.e(TAG, "å¸è½½æ’ä»¶å¤±è´¥: " + pluginId, e);

                // è®°å½•å¤±è´¥ï¼Œç¨åé‡è¯•
                scheduleRetryUnload(pluginId);
            }
        }

        Log.i(TAG, "åŒ11æ’ä»¶å¸è½½å®Œæˆï¼Œå…±" + double11Plugins.size() + "ä¸ª");
    }

    /**
     * å®‰å…¨å¸è½½æ’ä»¶
     */
    private void safeUnloadPlugin(String pluginId) {
        // 1. æ£€æŸ¥æ’ä»¶æ˜¯å¦æ­£åœ¨ä½¿ç”¨
        if (isPluginInUse(pluginId)) {
            Log.w(TAG, "æ’ä»¶æ­£åœ¨ä½¿ç”¨ä¸­: " + pluginId);

            // ç­‰å¾…ä½¿ç”¨ç»“æŸï¼ˆæœ€å¤š5ç§’ï¼‰
            if (!waitForPluginIdle(pluginId, 5000)) {
                // å¼ºåˆ¶åœæ­¢æ’ä»¶
                forceStopPlugin(pluginId);
            }
        }

        // 2. å¤‡ä»½æ’ä»¶çŠ¶æ€ï¼ˆç”¨äºæ¢å¤ï¼‰
        backupPluginState(pluginId);

        // 3. é€šçŸ¥æ’ä»¶å³å°†å¸è½½
        notifyPluginWillUnload(pluginId);

        // 4. æ‰§è¡Œå¸è½½
        unloadPluginInternal(pluginId);

        // 5. å‘é€å¸è½½å®Œæˆé€šçŸ¥
        notifyPluginUnloaded(pluginId);
    }

    /**
     * å¸è½½æ’ä»¶å†…éƒ¨é€»è¾‘
     */
    private void unloadPluginInternal(String pluginId) {
        try {
            // 1. ä»æ’ä»¶ç®¡ç†å™¨ä¸­ç§»é™¤
            PluginManager.getInstance().unloadPlugin(pluginId);

            // 2. æ¸…ç†æ’ä»¶æ–‡ä»¶
            cleanupPluginFiles(pluginId);

            // 3. æ¸…ç†æ’ä»¶ç¼“å­˜
            cleanupPluginCache(pluginId);

            // 4. æ¸…ç†æ’ä»¶æ•°æ®åº“
            cleanupPluginDatabase(pluginId);

            // 5. æ¸…ç†æ’ä»¶SharedPreferences
            cleanupPluginPreferences(pluginId);

            // 6. æ›´æ–°é…ç½®
            removePluginFromConfig(pluginId);

            Log.i(TAG, "æ’ä»¶å®Œå…¨å¸è½½: " + pluginId);

        } catch (Exception e) {
            Log.e(TAG, "å¸è½½æ’ä»¶å¼‚å¸¸: " + pluginId, e);
            throw new RuntimeException("å¸è½½æ’ä»¶å¤±è´¥", e);
        }
    }

    /**
     * æ¸…ç†æ’ä»¶æ–‡ä»¶
     */
    private void cleanupPluginFiles(String pluginId) {
        try {
            // æ’ä»¶å®‰è£…ç›®å½•
            File pluginBaseDir = new File(context.getFilesDir(), "plugins");
            File pluginDir = new File(pluginBaseDir, pluginId);

            if (pluginDir.exists() && pluginDir.isDirectory()) {
                // åˆ é™¤æ’ä»¶ç›®å½•
                deleteDirectoryRecursive(pluginDir);

                // åˆ é™¤æ’ä»¶APKæ–‡ä»¶
                File apkFile = new File(pluginBaseDir, pluginId + ".apk");
                if (apkFile.exists()) {
                    apkFile.delete();
                }

                // åˆ é™¤ç­¾åæ–‡ä»¶
                File sigFile = new File(pluginBaseDir, pluginId + ".sig");
                if (sigFile.exists()) {
                    sigFile.delete();
                }

                Log.i(TAG, "æ’ä»¶æ–‡ä»¶æ¸…ç†å®Œæˆ: " + pluginId);
            }

        } catch (Exception e) {
            Log.e(TAG, "æ¸…ç†æ’ä»¶æ–‡ä»¶å¤±è´¥: " + pluginId, e);
        }
    }

    /**
     * æ¸…ç†æ’ä»¶ç¼“å­˜
     */
    private void cleanupPluginCache(String pluginId) {
        try {
            // æ¸…ç†SharedPreferences
            String prefsName = "plugin_" + pluginId;
            SharedPreferences prefs = context.getSharedPreferences(
                prefsName, Context.MODE_PRIVATE);
            prefs.edit().clear().apply();

            // æ¸…ç†æ•°æ®åº“
            String dbName = pluginId + ".db";
            context.deleteDatabase(dbName);

            // æ¸…ç†æ–‡ä»¶ç¼“å­˜
            File cacheDir = new File(context.getCacheDir(), "plugin_" + pluginId);
            if (cacheDir.exists()) {
                deleteDirectoryRecursive(cacheDir);
            }

            // æ¸…ç†å›¾ç‰‡ç¼“å­˜
            File imageCacheDir = new File(context.getExternalCacheDir(),
                "plugin_images_" + pluginId);
            if (imageCacheDir.exists()) {
                deleteDirectoryRecursive(imageCacheDir);
            }

            Log.i(TAG, "æ’ä»¶ç¼“å­˜æ¸…ç†å®Œæˆ: " + pluginId);

        } catch (Exception e) {
            Log.e(TAG, "æ¸…ç†æ’ä»¶ç¼“å­˜å¤±è´¥: " + pluginId, e);
        }
    }

    /**
     * è·å–åŒ11æ’ä»¶åˆ—è¡¨
     */
    private List<String> getDouble11PluginIds() {
        // ä»é…ç½®ä¸­è·å–åŒ11æ’ä»¶åˆ—è¡¨
        List<String> double11Plugins = new ArrayList<>();

        // åŒ11æ´»åŠ¨æ’ä»¶
        double11Plugins.add("promotion_double11_2023");
        double11Plugins.add("flash_sale_double11");
        double11Plugins.add("shopping_cart_double11");
        double11Plugins.add("coupon_manager_double11");
        double11Plugins.add("payment_double11");
        double11Plugins.add("logistics_double11");

        // ä¸´æ—¶æ´»åŠ¨æ’ä»¶
        double11Plugins.add("live_shopping_double11");
        double11Plugins.add("group_buying_double11");
        double11Plugins.add("pre_sale_double11");

        return double11Plugins;
    }

    /**
     * åˆ¤æ–­åŒ11æ´»åŠ¨æ˜¯å¦çœŸçš„ç»“æŸ
     */
    private boolean isDouble11ReallyOver() {
        // 1. æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
        if (!checkServerActivityStatus()) {
            return false;
        }

        // 2. æ£€æŸ¥æœ¬åœ°æ—¶é—´
        if (!isAfterDouble11()) {
            return false;
        }

        // 3. æ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆè®¢å•
        if (hasPendingDouble11Orders()) {
            return false;
        }

        // 4. æ£€æŸ¥ç”¨æˆ·æ´»è·ƒåº¦
        if (isUserStillBrowsingDouble11()) {
            return false;
        }

        return true;
    }

    /**
     * ç”Ÿæˆæ¸…ç†æŠ¥å‘Š
     */
    private void generateCleanupReport() {
        CleanupReport report = new CleanupReport();

        report.cleanupTime = System.currentTimeMillis();
        report.totalPlugins = getDouble11PluginIds().size();
        report.cleanedPlugins = getCleanedPluginCount();
        report.failedPlugins = getFailedPluginCount();
        report.freedSpace = calculateFreedSpace();
        report.cleanupDuration = getCleanupDuration();

        // ä¿å­˜æŠ¥å‘Š
        saveCleanupReport(report);

        // ä¸ŠæŠ¥åˆ°æœåŠ¡å™¨
        uploadCleanupReport(report);

        Log.i(TAG, String.format("æ¸…ç†æŠ¥å‘Šç”Ÿæˆ: é‡Šæ”¾%sç©ºé—´ï¼Œæ¸…ç†%d/%dä¸ªæ’ä»¶",
            formatFileSize(report.freedSpace),
            report.cleanedPlugins,
            report.totalPlugins));
    }

    /**
     * æ’ä»¶å¸è½½ç¡®è®¤å¯¹è¯æ¡†
     */
    public void showUninstallConfirmDialog(Activity activity) {
        new AlertDialog.Builder(activity)
            .setTitle("æ¸…ç†åŒ11æ´»åŠ¨èµ„æº")
            .setMessage("åŒ11æ´»åŠ¨å·²ç»“æŸï¼Œæ˜¯å¦æ¸…ç†æ´»åŠ¨æ’ä»¶ä»¥èŠ‚çœç©ºé—´ï¼Ÿ\né¢„è®¡å¯é‡Šæ”¾" +
                calculateFreedSpace() + "å­˜å‚¨ç©ºé—´")
            .setPositiveButton("ç«‹å³æ¸…ç†", (dialog, which) -> {
                // ç«‹å³æ¸…ç†
                completeDouble11Cleanup();

                // æ˜¾ç¤ºæ¸…ç†ç»“æœ
                Toast.makeText(activity,
                    "åŒ11æ´»åŠ¨èµ„æºæ¸…ç†å®Œæˆ",
                    Toast.LENGTH_LONG).show();
            })
            .setNegativeButton("ç¨åæ¸…ç†", (dialog, which) -> {
                // 24å°æ—¶åå†æ¬¡æé†’
                scheduleCleanupReminder(24 * 60 * 60 * 1000);
            })
            .setNeutralButton("ä¸æ¸…ç†", (dialog, which) -> {
                // æ ‡è®°ä¸ºä¸æ¸…ç†
                markAsNoCleanupNeeded();
            })
            .show();
    }
}

/**
 * æ¸…ç†æŠ¥å‘Šç±»
 */
class CleanupReport {
    long cleanupTime;
    int totalPlugins;
    int cleanedPlugins;
    int failedPlugins;
    long freedSpace; // å­—èŠ‚
    long cleanupDuration; // æ¯«ç§’
    List<String> cleanedPluginIds = new ArrayList<>();
    List<String> failedPluginIds = new ArrayList<>();
    Map<String, String> errors = new HashMap<>();
}
```

* * *

## ğŸš€Â **å®Œæ•´çš„å¯åŠ¨å’Œé…ç½®ç¤ºä¾‹**

### **Double11Application.java**

java

```
package com.taobao.double11;

import android.app.Application;
import android.util.Log;

public class Double11Application extends Application {

    private static final String TAG = "Double11Application";

    // æ’ä»¶ç®¡ç†å™¨
    private Double11PluginManager pluginManager;

    // é€šä¿¡æ¡¥æ¢
    private Double11CommunicationBridge communicationBridge;

    // çƒ­ä¿®å¤ç®¡ç†å™¨
    private CouponHotFixManager hotFixManager;

    // èµ„æºç®¡ç†å™¨
    private ResourceHotFixManager resourceManager;

    // æ¸…ç†å™¨
    private Double11PluginCleaner pluginCleaner;

    @Override
    public void onCreate() {
        super.onCreate();

        Log.i(TAG, "åŒ11ç”µå•†åº”ç”¨å¯åŠ¨...");

        // åˆå§‹åŒ–æ’ä»¶åŒ–ç³»ç»Ÿ
        initPluginSystem();

        // åŒ11æœŸé—´çš„ç‰¹æ®Šå¤„ç†
        if (isDouble11Period()) {
            prepareForDouble11();
        }
    }

    /**
     * åˆå§‹åŒ–æ’ä»¶åŒ–ç³»ç»Ÿ
     */
    private void initPluginSystem() {
        Log.i(TAG, "åˆå§‹åŒ–æ’ä»¶åŒ–ç³»ç»Ÿ...");

        // 1. åˆå§‹åŒ–Shadowæ¡†æ¶
        Shadow.init(this);

        // 2. åˆ›å»ºæ’ä»¶ç®¡ç†å™¨
        pluginManager = Double11PluginManager.getInstance(this);

        // 3. åˆ›å»ºé€šä¿¡æ¡¥æ¢
        communicationBridge = Double11CommunicationBridge.getInstance(this);

        // 4. åˆ›å»ºçƒ­ä¿®å¤ç®¡ç†å™¨
        hotFixManager = new CouponHotFixManager(this);

        // 5. åˆ›å»ºèµ„æºç®¡ç†å™¨
        resourceManager = new ResourceHotFixManager(this,
            getFilesDir() + "/plugins/double11_main.apk");

        // 6. åˆ›å»ºæ¸…ç†å™¨
        pluginCleaner = new Double11PluginCleaner(this);

        Log.i(TAG, "æ’ä»¶åŒ–ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ");
    }

    /**
     * åŒ11å‡†å¤‡å·¥ä½œ
     */
    private void prepareForDouble11() {
        Log.i(TAG, "å¼€å§‹åŒ11å‡†å¤‡å·¥ä½œ...");

        // 1. æ£€æŸ¥å¹¶åŠ è½½åŒ11æ’ä»¶
        loadDouble11Plugins();

        // 2. åº”ç”¨çƒ­ä¿®å¤
        applyDouble11HotFixes();

        // 3. æ›´æ–°æ´»åŠ¨èµ„æº
        updateDouble11Resources();

        // 4. è®¾ç½®æ´»åŠ¨ç»“æŸç›‘å¬
        setupDouble11CleanupSchedule();

        Log.i(TAG, "åŒ11å‡†å¤‡å·¥ä½œå®Œæˆ");
    }

    /**
     * åŠ è½½åŒ11æ’ä»¶
     */
    private void loadDouble11Plugins() {
        List<PluginConfig> double11Plugins = new ArrayList<>();

        // ä¸»æ´»åŠ¨æ’ä»¶
        double11Plugins.add(new PluginConfig.Builder()
            .setPluginId("promotion_double11_2023")
            .setPluginPath(getFilesDir() + "/plugins/double11_main_v2.3.1.apk")
            .setVersion("2.3.1")
            .setPriority(10)
            .build());

        // è´­ç‰©è½¦æ’ä»¶
        double11Plugins.add(new PluginConfig.Builder()
            .setPluginId("shopping_cart_double11")
            .setPluginPath(getFilesDir() + "/plugins/cart_double11_v1.5.0.apk")
            .setVersion("1.5.0")
            .setPriority(9)
            .build());

        // æ”¯ä»˜æ’ä»¶
        double11Plugins.add(new PluginConfig.Builder()
            .setPluginId("payment_double11")
            .setPluginPath(getFilesDir() + "/plugins/payment_double11_v3.2.0.apk")
            .setVersion("3.2.0")
            .setPriority(8)
            .build());

        // åŠ è½½æ‰€æœ‰æ’ä»¶
        pluginManager.loadMultiplePlugins(double11Plugins);
    }

    /**
     * åº”ç”¨åŒ11çƒ­ä¿®å¤
     */
    private void applyDouble11HotFixes() {
        Log.i(TAG, "åº”ç”¨åŒ11çƒ­ä¿®å¤...");

        // 1. ä¼˜æƒ åˆ¸è®¡ç®—ä¿®å¤
        hotFixManager.applyCouponFix();

        // 2. å›¾ç‰‡åº“ä¼˜åŒ–
        SoHotFixManager soFixManager = new SoHotFixManager(this);
        soFixManager.optimizeImageLibsForDouble11();

        // 3. èµ„æºæ›´æ–°
        resourceManager.emergencyReplaceBanner();

        Log.i(TAG, "åŒ11çƒ­ä¿®å¤å®Œæˆ");
    }

    /**
     * è®¾ç½®åŒ11æ¸…ç†è®¡åˆ’
     */
    private void setupDouble11CleanupSchedule() {
        // åŒ11ç»“æŸåç¬¬2å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œæ¸…ç†
        Calendar cleanupTime = Calendar.getInstance();
        cleanupTime.set(Calendar.MONTH, Calendar.NOVEMBER);
        cleanupTime.set(Calendar.DAY_OF_MONTH, 12);
        cleanupTime.set(Calendar.HOUR_OF_DAY, 2);
        cleanupTime.set(Calendar.MINUTE, 0);
        cleanupTime.set(Calendar.SECOND, 0);

        AlarmManager alarmManager = (AlarmManager) getSystemService(ALARM_SERVICE);
        PendingIntent pendingIntent = PendingIntent.getBroadcast(
            this, 0, new Intent(this, Double11CleanupReceiver.class),
            PendingIntent.FLAG_UPDATE_CURRENT);

        alarmManager.set(AlarmManager.RTC_WAKEUP,
            cleanupTime.getTimeInMillis(), pendingIntent);

        Log.i(TAG, "åŒ11æ¸…ç†è®¡åˆ’å·²è®¾ç½®: " + cleanupTime.getTime());
    }
}

/**
 * åŒ11æ¸…ç†å¹¿æ’­æ¥æ”¶å™¨
 */
public class Double11CleanupReceiver extends BroadcastReceiver {
    @Override
    public void onReceive(Context context, Intent intent) {
        Log.i("Double11Cleanup", "æ”¶åˆ°åŒ11æ¸…ç†å¹¿æ’­");

        // æ‰§è¡Œæ¸…ç†
        Double11PluginCleaner cleaner = new Double11PluginCleaner(context);
        cleaner.completeDouble11Cleanup();
    }
}
```

* * *

## ğŸ“ŠÂ **ç›‘æ§å’Œå‘Šè­¦ç³»ç»Ÿ**

#### **PluginMonitor.java**

java

```
/**
 * æ’ä»¶ç›‘æ§ç³»ç»Ÿ
 * ç›‘æ§æ’ä»¶æ€§èƒ½ã€å´©æºƒç‡ã€ä½¿ç”¨æƒ…å†µ
 */
public class PluginMonitor {

    private static final String TAG = "PluginMonitor";

    // ç›‘æ§æ’ä»¶åŠ è½½æ—¶é—´
    public void monitorPluginLoadTime(String pluginId, long loadTime) {
        if (loadTime > 5000) { // è¶…è¿‡5ç§’è­¦å‘Š
            Log.w(TAG, "æ’ä»¶åŠ è½½è¶…æ—¶: " + pluginId + " - " + loadTime + "ms");
            reportWarning("plugin_load_timeout", pluginId, loadTime);
        }
    }

    // ç›‘æ§æ’ä»¶å´©æºƒç‡
    public void monitorPluginCrashRate(String pluginId, int crashCount, int launchCount) {
        double crashRate = (double) crashCount / launchCount * 100;

        if (crashRate > 1.0) { // å´©æºƒç‡è¶…è¿‡1%
            Log.e(TAG, "æ’ä»¶å´©æºƒç‡è¿‡é«˜: " + pluginId + " - " + crashRate + "%");
            reportError("plugin_high_crash_rate", pluginId, crashRate);

            // è‡ªåŠ¨è§¦å‘å›æ»š
            triggerAutoRollback(pluginId);
        }
    }

    // ç›‘æ§æ’ä»¶å†…å­˜ä½¿ç”¨
    public void monitorPluginMemory(String pluginId, long memoryUsage) {
        if (memoryUsage > 100 * 1024 * 1024) { // è¶…è¿‡100MB
            Log.w(TAG, "æ’ä»¶å†…å­˜ä½¿ç”¨è¿‡é«˜: " + pluginId + " - " +
                formatFileSize(memoryUsage));
            reportWarning("plugin_high_memory", pluginId, memoryUsage);
        }
    }

    // åŒ11æœŸé—´çš„ç‰¹æ®Šç›‘æ§
    public void double11SpecialMonitoring() {
        // å¢åŠ ç›‘æ§é¢‘ç‡
        setMonitoringInterval(1000); // æ¯ç§’ç›‘æ§

        // ç›‘æ§å…³é”®æŒ‡æ ‡
        monitorKeyMetrics();

        // è®¾ç½®å‘Šè­¦é˜ˆå€¼
        setAlertThresholds();

        // å¯ç”¨è‡ªåŠ¨ä¿®å¤
        enableAutoFix();
    }
}
```

* * *

## ğŸ¯Â **æ€»ç»“**

é€šè¿‡è¿™7ä¸ªæ ¸å¿ƒåŠŸèƒ½çš„å®ç°ï¼Œæˆ‘ä»¬æ„å»ºäº†ä¸€ä¸ªå®Œæ•´çš„ç”µå•†åŒ11å¤§ä¿ƒæ’ä»¶åŒ–ç³»ç»Ÿï¼š


## ğŸ”§ è¯¦ç»†ä»£ç å®ç°


## ğŸ¯Â **æ€»ç»“**

**Double11CommunicationBridge**Â å®ç°äº†å®¿ä¸»ä¸æ’ä»¶é—´çš„é«˜æ•ˆé€šä¿¡ï¼Œå…·æœ‰ä»¥ä¸‹æ ¸å¿ƒä¼˜åŠ¿ï¼š

### **æŠ€æœ¯äº®ç‚¹ï¼š**

1.  **åŒå‘é€šä¿¡**ï¼šæ”¯æŒæ’ä»¶â†”å®¿ä¸»çš„åŒå‘æœåŠ¡è°ƒç”¨
1.  **å¤šç§è°ƒç”¨æ¨¡å¼**ï¼šåŒæ­¥ã€å¼‚æ­¥ã€Callbackã€Future
1.  **äº‹ä»¶é©±åŠ¨æ¶æ„**ï¼šæ”¯æŒè®¢é˜…/å‘å¸ƒæ¨¡å¼ï¼Œè§£è€¦ç»„ä»¶
1.  **æ•°æ®å…±äº«æœºåˆ¶**ï¼šè·¨æ’ä»¶æ•°æ®å…±äº«ï¼Œæ”¯æŒTTLè¿‡æœŸ
1.  **Fragmentæ— ç¼é›†æˆ**ï¼šæ’ä»¶UIå¯ç›´æ¥åµŒå…¥å®¿ä¸»é¡µé¢
1.  **å®Œå–„çš„ç›‘æ§**ï¼šè®°å½•è°ƒç”¨æ¬¡æ•°ã€è€—æ—¶ã€æˆåŠŸç‡ç­‰æŒ‡æ ‡




## ä¸ƒä¸ªéœ€æ±‚ç‚¹å®Œæ•´éªŒè¯æ–¹æ¡ˆ

| éœ€æ±‚ç¼–å·  | éœ€æ±‚åç§°               | ä¸šåŠ¡åœºæ™¯          | éªŒè¯æŒ‡æ ‡                                                     | éªŒè¯æ–¹æ³•                                    | é€šè¿‡æ ‡å‡†                                                                    | éªŒè¯å·¥å…·/è„šæœ¬                                                                         | é£é™©ç‚¹                                    |
| ----- | ------------------ | ------------- | -------------------------------------------------------- | --------------------------------------- | ----------------------------------------------------------------------- | ------------------------------------------------------------------------------- | -------------------------------------- |
| **1** | åŠ¨æ€åŠ è½½APK æ–°å¢Activity | åŒ11é™æ—¶ç§’æ€æ´»åŠ¨     | 1. æ’ä»¶åŠ è½½æˆåŠŸç‡ 2. Activityå¯åŠ¨è€—æ—¶ 3. å†…å­˜å ç”¨ 4. èµ„æºåŠ è½½æ­£ç¡®æ€§ 5. ç”Ÿå‘½å‘¨æœŸå®Œæ•´æ€§ | 1. è‡ªåŠ¨åŒ–åŠ è½½æµ‹è¯• 2. æ€§èƒ½ç›‘æ§ 3. UIè‡ªåŠ¨åŒ–æµ‹è¯• 4. å†…å­˜æ³„æ¼æ£€æµ‹ | 1. æˆåŠŸç‡â‰¥99.9% 2. å¯åŠ¨æ—¶é—´â‰¤500ms 3. å†…å­˜å¢åŠ â‰¤20MB 4. èµ„æºæ— ç¼ºå¤± 5. ç”Ÿå‘½å‘¨æœŸæ— å¼‚å¸¸             | `PluginLoadTest.java` `ActivityPerformanceTest.kt` `MemoryMonitorTool`          | 1. æ’ä»¶ç­¾åéªŒè¯å¤±è´¥ 2. èµ„æºIDå†²çª 3. Activityä¸»é¢˜ä¸å…¼å®¹ |
| **2** | çƒ­ä¿®å¤ä¸€ä¸ªç±»             | ä¼˜æƒ åˆ¸å åŠ è®¡ç®—é€»è¾‘ç´§æ€¥ä¿®å¤ | 1. çƒ­ä¿®å¤æˆåŠŸç‡ 2. ä¿®å¤ç”Ÿæ•ˆæ—¶é—´ 3. è®¡ç®—æ­£ç¡®ç‡ 4. å…¼å®¹æ€§éªŒè¯ 5. å›æ»šæˆåŠŸç‡           | 1. å•å…ƒæµ‹è¯• 2. A/Bæµ‹è¯• 3. ç°åº¦å‘å¸ƒéªŒè¯ 4. å›æ»šæµ‹è¯•      | 1. æˆåŠŸç‡â‰¥99.5% 2. ç”Ÿæ•ˆæ—¶é—´â‰¤5åˆ†é’Ÿ 3. è®¡ç®—æ­£ç¡®ç‡100% 4. å…¼å®¹æ€§100% 5. å›æ»šæˆåŠŸç‡100%           | `HotFixVerifier.java` `ABTestPlatform` `RollbackTestSuite`                      | 1. ClassLoaderå†²çª 2. Dexæ–‡ä»¶æŸå 3. å¤šçº¿ç¨‹ç¯å¢ƒé—®é¢˜ |
| **3** | çƒ­ä¿®å¤æ›¿æ¢èµ„æºæ–‡ä»¶          | æ´»åŠ¨å›¾ç‰‡/æ–‡æ¡ˆç´§æ€¥æ›´æ¢   | 1. èµ„æºæ›¿æ¢æˆåŠŸç‡ 2. æ›´æ–°ç”Ÿæ•ˆæ—¶é—´ 3. å¤šè¯­è¨€æ”¯æŒ 4. ç¼“å­˜æ¸…ç†æ•ˆæœ 5. A/Bæµ‹è¯•å‡†ç¡®æ€§      | 1. èµ„æºå¯¹æ¯”æµ‹è¯• 2. å¤šè¯­è¨€éªŒè¯ 3. ç¼“å­˜æµ‹è¯• 4. A/Bæµ‹è¯•æ•°æ®æ”¶é›† | 1. æˆåŠŸç‡â‰¥99.8% 2. ç”Ÿæ•ˆæ—¶é—´â‰¤2åˆ†é’Ÿ 3. å¤šè¯­è¨€è¦†ç›–ç‡100% 4. ç¼“å­˜æ¸…ç†ç‡100% 5. A/Bæµ‹è¯•æ•°æ®å‡†ç¡®        | `ResourceUpdateTest.java` `CacheValidator.kt` `ABTestAnalyzer`                  | 1. èµ„æºIDå†²çª 2. å›¾ç‰‡æ ¼å¼ä¸å…¼å®¹ 3. å¤šè¯­è¨€èµ„æºé—æ¼        |
| **4** | çƒ­ä¿®å¤ä¸€ä¸ªSOåº“           | å›¾ç‰‡åŠ è½½åº“æ€§èƒ½ä¼˜åŒ–     | 1. SOåº“åŠ è½½æˆåŠŸç‡ 2. æ€§èƒ½æå‡æ¯”ä¾‹ 3. å´©æºƒç‡å˜åŒ– 4. å¤šæ¶æ„å…¼å®¹æ€§ 5. å†…å­˜æ³„æ¼æ£€æµ‹       | 1. æ€§èƒ½å‹æµ‹ 2. å´©æºƒç›‘æ§ 3. æ¶æ„å…¼å®¹æµ‹è¯• 4. å†…å­˜æ³„æ¼æ£€æµ‹     | 1. åŠ è½½æˆåŠŸç‡â‰¥99.9% 2. æ€§èƒ½æå‡â‰¥20% 3. å´©æºƒç‡â‰¤0.1% 4. å…¨æ¶æ„å…¼å®¹ 5. æ— æ–°å¢å†…å­˜æ³„æ¼              | `SoPerformanceTest.java` `CrashMonitor` `MemoryLeakDetector`                    | 1. CPUæ¶æ„ä¸åŒ¹é… 2. ç¬¦å·è¡¨ä¸å…¼å®¹ 3. æƒé™é—®é¢˜          |
| **5** | å¤šæ’ä»¶ç®¡ç†ä¸çƒ­æ›´æ–°          | å…¨é“¾è·¯è´­ç‰©æµç¨‹æ’ä»¶åŒ–    | 1. å¤šæ’ä»¶å¹¶è¡ŒåŠ è½½ 2. æ›´æ–°æˆåŠŸç‡ 3. ç‰ˆæœ¬å…¼å®¹æ€§ 4. ç°åº¦å‘å¸ƒæ•ˆæœ 5. å›æ»šæœºåˆ¶æœ‰æ•ˆæ€§        | 1. å¹¶å‘åŠ è½½æµ‹è¯• 2. æ›´æ–°æµç¨‹æµ‹è¯• 3. ç‰ˆæœ¬çŸ©é˜µæµ‹è¯• 4. ç°åº¦å‘å¸ƒéªŒè¯ | 1. å¹¶è¡ŒåŠ è½½æˆåŠŸç‡â‰¥99.5% 2. æ›´æ–°æˆåŠŸç‡â‰¥99.7% 3. ç‰ˆæœ¬å…¼å®¹æ€§100% 4. ç°åº¦å‘å¸ƒå¯æ§ 5. å›æ»šâ‰¤2åˆ†é’Ÿ        | `MultiPluginTestSuite.java` `VersionCompatibilityTest` `CanaryReleaseValidator` | 1. æ’ä»¶ä¾èµ–å†²çª 2. ç‰ˆæœ¬å…¼å®¹æ€§é—®é¢˜ 3. ç½‘ç»œå¼‚å¸¸å¯¼è‡´æ›´æ–°å¤±è´¥     |
| **6** | å®¿ä¸»ä¸æ’ä»¶é€šä¿¡            | æ’ä»¶ä¸å®¿ä¸»åŒå‘è°ƒç”¨     | 1. é€šä¿¡æˆåŠŸç‡ 2. å“åº”æ—¶é—´ 3. æ•°æ®ä¸€è‡´æ€§ 4. å¹¶å‘å¤„ç†èƒ½åŠ› 5. é”™è¯¯å¤„ç†æœºåˆ¶            | 1. æ¥å£åŠŸèƒ½æµ‹è¯• 2. æ€§èƒ½å‹æµ‹ 3. æ•°æ®ä¸€è‡´æ€§éªŒè¯ 4. é”™è¯¯æ³¨å…¥æµ‹è¯•  | 1. é€šä¿¡æˆåŠŸç‡â‰¥99.99% 2. å¹³å‡å“åº”æ—¶é—´â‰¤50ms 3. æ•°æ®ä¸€è‡´æ€§100% 4. å¹¶å‘é‡â‰¥1000QPS 5. é”™è¯¯æ¢å¤ç‡100% | `CommunicationTest.java` `LoadTestTool` `DataConsistencyChecker`                | 1. åºåˆ—åŒ–å¼‚å¸¸ 2. å†…å­˜æ³„æ¼ 3. æ­»é”é—®é¢˜               |
| **7** | åŒ11æ´»åŠ¨ç»“æŸå¸è½½æ’ä»¶        | æ´»åŠ¨ç»“æŸåæ¸…ç†æ’ä»¶     | 1. å¸è½½æˆåŠŸç‡ 2. èµ„æºæ¸…ç†ç‡ 3. æ•°æ®è¿ç§»å®Œæ•´æ€§ 4. ç”¨æˆ·æ— æ„ŸçŸ¥ç‡ 5. å­˜å‚¨ç©ºé—´é‡Šæ”¾         | 1. å¸è½½åŠŸèƒ½æµ‹è¯• 2. èµ„æºæ¸…ç†éªŒè¯ 3. æ•°æ®è¿ç§»æµ‹è¯• 4. ç”¨æˆ·ä½“éªŒè°ƒæŸ¥ | 1. å¸è½½æˆåŠŸç‡100% 2. èµ„æºæ¸…ç†ç‡100% 3. æ•°æ®è¿ç§»å®Œæ•´æ€§100% 4. ç”¨æˆ·æ— æ„ŸçŸ¥ç‡â‰¥95% 5. å­˜å‚¨é‡Šæ”¾â‰¥50MB     | `PluginCleanupTest.java` `StorageAnalyzer` `UserSurveyTool`                     | 1. æ’ä»¶æ­£åœ¨ä½¿ç”¨æ— æ³•å¸è½½ 2. æ•°æ®è¿ç§»å¤±è´¥ 3. ç”¨æˆ·æ•°æ®ä¸¢å¤±




