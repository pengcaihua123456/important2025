
## 1. **业务背景**

一个完整的电商双11大促插件化系统：

**业务场景**：双11当天0点，需要上线全新的「限时秒杀」活动页面，包含倒计时、库存秒杀、弹幕互动等复杂功能。传统发版需等待应用商店审核，而插件化可以实现：

-   11月10日23:50 提前预加载秒杀插件
-   11月11日0:00 立即激活秒杀页面
### 1.1 为啥我的电商项目用插件化?

**常规发版需要7-15天审核周期，错过营销时机** 经常有很多活动

**老用户无法体验最新的功能**，必须发版本，强制升级才行！ 但有的用户不喜欢强制升级！

**包体积膨胀**：每次新增功能都增加APK体积，影响下载转化率

**灵活性差**：无法针对不同用户群体展示不同购物流程

### 1.2 详细的电商需求
```
1.如何加载一个双11活动插件
2.插件奔溃，怎么处理 (重点)
  双11活动插件有奔溃问题
自动回退到基础版本？是所有的用户都回退吗?
 降级策略
3.如何卸载插件?
 双11活动结束,插件在本地暂用磁盘
4. 如何加载插件中新增一个Activity，双11活动插件
四大组件支持情况：Activity 完全支持，Service/Broadcast/ContentProvider 的限制与替代方案
5. 如何加载新增的Fragment，双11活动插件?
6.宿主与插件之间如何高效通信？
插件获取宿主信息：(用户信息：插件需要获取登录状态、收货地址)
宿主获取插件信息：（购物车同步：插件添加商品，宿主购物车实时更新）
插件与宿主通信：同一个进程， 通过预定义接口（Service、Callback）实现双向调用
插件和插件通信：
7.shadow如何更新：多插件管理、版本控制与热更新策略 !  宿主的版本和插件如果要更新怎么样
插件动态更新策略, 多插件管理：同时加载多个插件的策略
插件生命周期管理 &&  插件动态化部署
       第一次版本，宿主A,包含2个插件，插件B 和插件C， 都是1.0版本
       过了7天，发现插件B有bug，热修复，插件B是2.0版本
       第二次发版：宿主A 3.0，插件B，C都有更新，同时新增插件D   都是3.0版本
8.热修复一个类:优惠券叠加计算逻辑紧急修复，同时有一个奔溃问问题
9.热修复替换一个资源文件: 发现活动主图侵犯版权，需立即更换
插件内使用自己的资源，避免冲突
10.热修复一个so文件:图片加载so库，会有奔溃
```

### 1.3 电商App的架构

双11，新增了一个双11tab的入口

```
常规架构：
首页 → 分类 → 购物车 → 我的

双11架构：
首页 → 双11主会场 → 分类 → 购物车 → 我的
           ↑
        插件化实现
```

### 效果图

### 总体架构图
```
电商主APP (宿主)
├── 基础框架层
├── 插件管理引擎 (Shadow)
└── 核心业务插件
    ├── 首页插件
    ├── 分类插件
    ├── 购物车插件
    └── 我的插件
    └── 双11插件
```

## 2. 整体的架构是怎么样的？分层 （需要修改插件）

```
EcommerceDouble11/
├── app/                            # 宿主应用
├── plugin-manager/                 # 插件管理器
├── plugin-sdk/                     # 宿主插件通信SDK
├── plugins/                        # 插件集合
│   ├── promotion-double11/         # 双11活动主插件
│   ├── shopping-cart-double11/     # 购物车插件
│   ├── flash-sale/                 # 分类插件
│   ├── coupon-manager/             # 我的插件
├── hotfix/                         # 热修复模块
├── update-manager/                 # 更新管理器
└── buildSrc/                       # 构建脚本
    plugin-common/                  # 公共库插件
```

宿主：Host
插件: 首页, 分类，购物，我的，新增双11主会场

### 2.2 业务流程图

### 2.3 shadow 封装宿主，和插件
### 模块划分

## 3. 具体需求的实现

```
1.如何加载一个双11活动插件
2.插件奔溃，怎么处理 ,双11活动插件有奔溃问题
3.如何卸载插件?
 双11活动结束,插件在本地暂用磁盘
4. 如何加载插件中新增一个Activity，双11活动插件
四大组件支持情况：Activity 完全支持，Service/Broadcast/ContentProvider 的限制与替代方案
5. 如何加载新增的Fragment，双11活动插件?
6.宿主与插件之间如何高效通信？
插件获取宿主信息：(用户信息：插件需要获取登录状态、收货地址)
宿主获取插件信息：（购物车同步：插件添加商品，宿主购物车实时更新）
插件与宿主通信：同一个进程， 通过预定义接口（Service、Callback）实现双向调用
插件和插件通信：
7.shadow如何更新：多插件管理、版本控制与热更新策略 !  宿主的版本和插件如果要更新怎么样
插件动态更新策略, 多插件管理：同时加载多个插件的策略
插件生命周期管理 &&  插件动态化部署
       第一次版本，宿主A,包含2个插件，插件B 和插件C， 都是1.0版本
       过了7天，发现插件B有bug，热修复，插件B是2.0版本
       第二次发版：宿主A 3.0，插件B，C都有更新，同时新增插件D   都是3.0版本
8.热修复一个类:优惠券叠加计算逻辑紧急修复，同时有一个奔溃问问题
9.热修复替换一个资源文件: 发现活动主图侵犯版权，需立即更换
插件内使用自己的资源，避免冲突
10.热修复一个so文件:图片加载so库，会有奔溃
```
### 3.1  如何加载一个双11活动插件,动态加载APK，双11限时秒杀活动
**业务场景**：双11当天0点，需要上线全新的「限时秒杀」活动页面，包含倒计时、库存秒杀、弹幕互动等复杂功能

FlashSalePlugin

### 3.2 插件奔溃，怎么处理 ,双11活动插件有奔溃问题

### 3.3.如何卸载插件?
**业务场景**：11月12日00:00活动结束：
1.  **空间回收**：删除临时插件，释放50-100MB存储空间， 双11活动结束,插件在本地暂用磁盘

### 3.4. 如何加载插件中新增一个Activity，双11活动插件

### 3.5. 如何加载新增的Fragment，双11活动插件?
本来是fragment，现在调整到fragment,还是跳转到activity!



### 3.6.宿主与插件之间如何高效通信？
插件获取宿主信息：(用户信息：插件需要获取登录状态、收货地址)
宿主获取插件信息：（购物车同步：插件添加商品，宿主购物车实时更新）
插件与宿主通信：同一个进程， 通过预定义接口（Service、Callback）实现双向调用
插件和插件通信：（双11活动插件，添加商品到了购物车插件）


### **宿主与插件通信**
#### **Double11CommunicationBridge.java**


### 3.7.shadow如何更新：多插件管理、版本控制与热更新策略 !  宿主的版本和插件如果要更新怎么样
插件动态更新策略, 多插件管理：同时加载多个插件的策略
插件生命周期管理 &&  插件动态化部署
       第一次版本，宿主A,包含2个插件，插件B 和插件C， 都是1.0版本
       过了7天，发现插件B有bug，热修复，插件B是2.0版本
       第二次发版：宿主A 3.0，插件B，C都有更新，同时新增插件D   都是3.0版本



##### 建立插件间的依赖关系图
管理插件与宿主的版本兼容关系
```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  宿主A 1.0       │     │  插件热更新       │     │  宿主A 3.0       │
│  - 插件B 1.0     │────▶│  插件B 2.0       │────▶│  - 插件B 3.0     │
│  - 插件C 1.0     │     │  插件C 1.0       │     │  - 插件C 3.0     │
│                 │     │                 │     │  - 插件D 3.0     │
└─────────────────┘     └─────────────────┘     └─────────────────┘
```

#### **Double11PluginManager**


### 3.8.热修复一个类:优惠券叠加计算逻辑紧急修复，同时有一个奔溃问问题
**业务场景**：双11期间发现优惠券叠加计算Bug：满300减50的店铺券与满200减20的平台券同时使用时，计算金额错误，导致用户多付或少付款。需要：
-   快速定位问题所在类 `CouponCalculator.java`
-   开发修复版本，生成修复Dex文件
-   通过后台配置系统，向所有用户推送热修复包
-   用户下次打开购物车时自动应用修复，无需重启App

热修复是全量更新，还是增量更新？
结论：Shadow 的“热修复”本质上是「插件全量更新」，不是增量热修复（如修复单个方法）

### 基于Shadow的类级别热修复

### **优惠券计算器修复** CouponHotFixManager.java


#### **热修复配置文件**


```
// hotfix_config.json
{
  "hotfixes": [
    {
      "id": "coupon_calc_fix_20231101",
      "className": "com.taobao.app.coupon.CouponCalculator",
      "version": "1.2.0",
      "description": "修复双11优惠券叠加计算逻辑错误",
      "downloadUrl": "https://cdn.taobao.com/hotfix/double11/coupon_fix_v1.2.dex",
      "md5": "a1b2c3d4e5f678901234567890123456",
      "minAppVersion": "9.5.0",
      "maxAppVersion": "9.8.0",
      "applyStrategy": {
        "type": "immediate",
        "conditions": ["wifi_only", "battery_high"],
        "rollbackOnFailure": true
      },
      "affectedUsers": "all",
      "releaseTime": "2023-11-01T10:00:00Z",
      "expireTime": "2023-11-15T23:59:59Z"
    }
  ]
}
```

### 3.9.热修复替换一个资源文件: 发现活动主图侵犯版权，需立即更换
**业务场景**：发现活动主图侵犯版权，需立即更换, 活动文案涉及敏感词，需立即修改

#### **ResourceHotFixManager.java**


### 3.10.热修复一个so文件:图片加载so库，会有奔溃

**业务场景**：双11期间图片加载量剧增，发现：需要紧急替换为优化后的Native库
**解决方案**：在不发版的情况下，动态替换 `libimage_decoder.so` 库文件

#### **SoHotFixManager.java**


## 4.业务场景总结表

| 需求 | 业务场景       | 触发时机          | 技术实现             |
| -- | ---------- | ------------- | ---------------- |
| 1  | 加载双11插件    | 点击Tab、App启动   | Shadow动态加载       |
| 2  | 插件崩溃处理     | 运行中崩溃         | 异常捕获+自动恢复        |
| 3  | 卸载插件       | 活动结束、存储不足     | 数据迁移+文件删除        |
| 4  | 加载Activity | 进入活动页面        | Shadow代理Activity |
| 5  | 加载Fragment | 首页嵌入活动        | 类加载+注入           |
| 6  | 宿主插件通信     | 数据同步、用户操作     | 接口通信+事件总线        |
| 7  | 热更新策略      | 版本更新、bug修复    | 灰度发布+版本管理        |
| 8  | 类热修复       | 逻辑错误、崩溃       | Dex替换+类加载        |
| 9  | 资源热修复      | 图片侵权、文案错误     | 资源包替换            |
| 10 | SO库热修复     | Native崩溃、性能问题 | SO文件替换

## 5. 上线后实际效果对比
### 5.1 崩溃率统计
### 5.2 插件性能监控
### 5.3 性能监控（加载时间、内存占用）



day1: 把项目搭建好！
day2: 把基本的4个table，fragment创建
day3: 集成shadow，分类，购物车，我的是单独的插件
day4: 添加双11的插件: activity,fragment
day5: 双11插件和购物车插件的通信
day6： 卸载插件
day7： 版本管理和全量的热修复